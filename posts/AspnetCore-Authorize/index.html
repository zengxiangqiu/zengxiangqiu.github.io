<!DOCTYPE html><html lang="zh-CN" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="天前"><meta name="hour-prompt" content="小时前"><meta name="minute-prompt" content="分钟前"><meta name="justnow-prompt" content="刚刚"><meta name="generator" content="Jekyll v4.3.4" /><meta property="og:title" content="AspnetCore Authorize" /><meta property="og:locale" content="zh_CN" /><meta name="description" content="1. 重点" /><meta property="og:description" content="1. 重点" /><link rel="canonical" href="https://zengxiangqiu.github.io/posts/AspnetCore-Authorize/" /><meta property="og:url" content="https://zengxiangqiu.github.io/posts/AspnetCore-Authorize/" /><meta property="og:site_name" content="zengxiangqiu" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-12-28T15:37:11+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="AspnetCore Authorize" /><meta name="twitter:site" content="@zengxiangqiu" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-04-20T17:16:08+08:00","datePublished":"2021-12-28T15:37:11+08:00","description":"1. 重点","headline":"AspnetCore Authorize","mainEntityOfPage":{"@type":"WebPage","@id":"https://zengxiangqiu.github.io/posts/AspnetCore-Authorize/"},"url":"https://zengxiangqiu.github.io/posts/AspnetCore-Authorize/"}</script><title>AspnetCore Authorize | zengxiangqiu</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="zengxiangqiu"><meta name="application-name" content="zengxiangqiu"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="zh-CN"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> </a></div><div class="site-title mt-3"> <a href="/">zengxiangqiu</a></div><div class="site-subtitle font-italic">知识库</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>首页</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>分类</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>标签</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>归档</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>关于</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/zengxiangqiu" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/zengxiangqiu" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['example','doamin.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> 首页 </a> </span> <span>AspnetCore Authorize</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> 文章</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="搜索..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >取消</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>AspnetCore Authorize</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> zengxiangqiu </span> 发表于 <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="2021-12-28, 15:37 +0800" >2021-12-28<i class="unloaded">2021-12-28T15:37:11+08:00</i> </span></div><div> <span> 更新于 <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="2022-04-20, 17:16 +0800" >2022-04-20<i class="unloaded">2022-04-20T17:16:08+08:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1385 字">7 分钟 阅读</span></div></div><div class="post-content"><h2 id="1-重点">1. 重点</h2><p>jwt 包括三部分，header、payload以及signature，前两部分可以被base64解析，而保证jwt不被篡改的关键在于 <strong>signature</strong>,因为采用了SHA256hash散列算法，当验证服务端（identity server）收到token时，将解析header和payload后利用密钥和算法生成对应的signature,与原token中的作比较，另外jwt中的nonce可以抵御重放攻击。</p><p>颁发令牌token之后，客户端所请求的资源范围如与jwt中的不符将不被允许，如客户端或中间人修改jwt playload base64内容，因签名不一致，将被拒绝</p><p>参考<a href="https://stackoverflow.com/questions/31309759/what-is-secret-key-for-jwt-based-authentication-and-how-to-generate-it">这里</a></p><h2 id="2-audience">2. audience</h2><p>预期的受众</p><p>ids 4 中提到</p><blockquote><p>When using the scope-only model, no aud (audience) claim will be added to the token, since this concept does not apply. If you need an aud claim, you can enable the EmitStaticAudience setting on the options. This will emit an aud claim in the issuer_name/resources format. If you need more control of the aud claim, use API resources.</p></blockquote><p>EmitStaticAudience=true启用后默认aud=issuer_name/resources</p><p>还有<a href="https://qastack.cn/programming/28418360/jwt-json-web-token-audience-aud-versus-client-id-whats-the-difference">QAStack</a>中的回答：</p><blockquote><p>JWT将包含一个aud声明，该声明指定JWT适用于哪些资源服务器。如果aud包含www.myfunwebapp.com，但客户端应用程序尝试在上使用JWT www.supersecretwebapp.com，则访问将被拒绝，因为该资源服务器将看到JWT并不适合它。</p></blockquote><p>例如，当某ApiResourse的scope包含XXX.read，某ApiClient也包含该scope，请求的access token的aud将包含apiresourse的name。</p><p><a href="https://www.mrjamiebowman.com/microservices/identity-server-4-clientcredentials-with-postman/">Identity Server 4 ClientCredentials with POSTMAN</a> 非常简单易懂的项目，有源码，可以作为入门。</p><p>API 资源服务中设置</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span text-data=" C# "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre> <span class="p">.</span><span class="nf">AddJwtBearer</span><span class="p">(</span><span class="s">"Bearer"</span><span class="p">,</span> <span class="n">options</span> <span class="p">=&gt;</span>
           <span class="p">{</span>
               <span class="n">options</span><span class="p">.</span><span class="n">Authority</span> <span class="p">=</span> <span class="s">"https://localhost:5001"</span><span class="p">;</span>

               <span class="n">options</span><span class="p">.</span><span class="n">TokenValidationParameters</span> <span class="p">=</span> <span class="k">new</span> <span class="n">TokenValidationParameters</span>
               <span class="p">{</span>
                   <span class="n">ValidateAudience</span> <span class="p">=</span> <span class="k">true</span>
               <span class="p">};</span>

               <span class="c1">// if you are using API resources, you can specify the name here</span>
               <span class="c1">// options.Audience = "https://localhost:5001/resources";</span>
                <span class="n">options</span><span class="p">.</span><span class="n">Audience</span> <span class="p">=</span> <span class="s">"StaffApi"</span><span class="p">;</span>
               <span class="c1">// IdentityServer emits a typ header by default, recommended extra check</span>
               <span class="n">options</span><span class="p">.</span><span class="n">TokenValidationParameters</span><span class="p">.</span><span class="n">ValidTypes</span> <span class="p">=</span> <span class="k">new</span><span class="p">[]</span> <span class="p">{</span> <span class="s">"at+jwt"</span> <span class="p">};</span>
           <span class="p">});</span>
</pre></table></code></div></div><p>表示该API服务的受众是某个授权中心，用户请求的令牌中的aud需与此一致。</p><h2 id="identityserver4">IdentityServer4</h2><h3 id="discovery-document">discovery Document</h3><blockquote><p>The discovery endpoint is available via /.well-known/openid-configuration relative to the base address of your Token Server</p></blockquote><p>在docker中运行的ids4,discovery endpoint link 显示问题,因为docker 的桥接网络和由nginx代理，所有实际的endpoint是 https://IdentityServer:5002/connect/authorize 或者 https://172.xx.xx.xxx/identityserver/connect/authorize (由nginx location rule proxy)</p><p>{ “issuer”: “https://IdentityServer:5002”, “jwks_uri”: “https://172.xx.xx.xxx/.well-known/openid-configuration/jwks”, “authorization_endpoint”: “https://172.xx.xx.xxx/connect/authorize”, …. }</p><p>见<a href="https://vmsdurano.com/apiboilerplate-and-identityserver4-access-control-for-apis/">IdentityServer4: Building a Simple Token Server and Protecting Your ASP.NET Core APIs with JWT</a></p><h2 id="3-claims">3. Claims</h2><p><a href="https://stackoverflow.com/questions/37067938/understanding-claims">Understanding Claims</a>提到</p><blockquote><p>Scopes are identifiers used to specify what access privileges are being requested. Claims are name/value pairs that contain information about a user.</p></blockquote><p>So an example of a good scope would be “read_only”. Whilst an example of a claim would be “email”: “john.smith@example.com”.</p><p>scope代表该token的权限范围，claims 代表user信息。</p><h2 id="4-scoped">4. Scoped</h2><p>ids 4 配置 Client Scoped , 客户端（web）通过disconvery 中的 endpoint 发送授权请求，其中request 中 scoped会与ids4中已注册的ApiScoped比较并放入claims，返回granted code 或 access token</p><p>客户端 再 利用access token 请求 资源，资源服务（microservice） 通过[Authorize] 和[RequiredScope] 验证 token 中scope 是否符合。</p><p><a href="https://procodeguide.com/programming/oauth2-and-openid-connect-in-aspnet-core/">Secure Applications with OAuth2 and OpenID Connect in ASP.NET Core 5 – Complete Guide</a> 详尽地介绍了OpenID Connection和OAuth 2.0 ，并结合identity server 4 讲解原理，可读性高，又源码，可以细读学习。</p><h2 id="5-笔记">5. 笔记</h2><ol><li><p><strong>Identity Resources</strong> are some standard open id connect scopes…</p><p>用户身份识别的内容，比如email，profile，website等等</p><li><p><strong>API Resources</strong> are used to define the API that the identity server is protecting</p><p>被保护的资源，比如microservive架构的服务提供，体现在Request中的aud （audient受众）</p><p>ApiResource 包含 one or more ApiScope，参考<a href="https://identityserver4.readthedocs.io/en/latest/topics/resources.html">Defining Resources</a></p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span text-data=" C# "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>  <span class="k">new</span> <span class="nf">ApiResource</span><span class="p">(</span><span class="s">"invoice"</span><span class="p">,</span> <span class="s">"Invoice API"</span><span class="p">)</span>
     <span class="p">{</span>
         <span class="n">Scopes</span> <span class="p">=</span> <span class="p">{</span> <span class="s">"invoice.read"</span><span class="p">,</span> <span class="s">"invoice.pay"</span><span class="p">,</span> <span class="s">"manage"</span> <span class="p">}</span>
     <span class="p">},</span>
</pre></table></code></div></div><li><p>api服务端</p></ol><p>This Authentication configuration will make use of the discovery document on startup to configure the security for this API</p><p>api服务利用 ids4 发现文档 知道endpoints，比如验证 token是否有效等</p><p>当客户端（网页/手机）请求资源时，必须带上token</p><pre><code class="language-nuget">Install-Package IdentityServer4.AccessTokenValidation
</code></pre><div class="language-csharp highlighter-rouge"><div class="code-header"> <span text-data=" C# "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="n">services</span><span class="p">.</span><span class="nf">AddAuthentication</span><span class="p">(</span><span class="s">"Bearer"</span><span class="p">)</span>
<span class="p">.</span><span class="nf">AddIdentityServerAuthentication</span><span class="p">(</span><span class="s">"Bearer"</span><span class="p">,</span> <span class="n">options</span> <span class="p">=&gt;</span>
<span class="p">{</span>
  <span class="n">options</span><span class="p">.</span><span class="n">ApiName</span> <span class="p">=</span> <span class="s">"weatherApi"</span><span class="p">;</span>
  <span class="n">options</span><span class="p">.</span><span class="n">Authority</span> <span class="p">=</span> <span class="s">"https://localhost:44343"</span><span class="p">;</span>
<span class="p">});</span>
</pre></table></code></div></div><div class="language-csharp highlighter-rouge"><div class="code-header"> <span text-data=" C# "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">app</span><span class="p">.</span><span class="nf">UseAuthorization</span><span class="p">();</span>
</pre></table></code></div></div><p>ApiName 对应已注册的API Resources，最后在pipline中调用</p><ol><li>Client Credentials flow 中不建议根据Scope来限制访问</ol><p><a href="https://www.oauth.com/oauth2-servers/access-tokens/client-credentials/">Client Credentials</a></p><blockquote><p>scope (optional) Your service can support different scopes for the client credentials grant. In practice, not many services actually support this.</p></blockquote><p><a href="https://docs.duendesoftware.com/identityserver/v5/apis/aspnetcore/authorization/">Authorization based on Scopes and other Claims</a>中建议</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span text-data=" C# "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="n">services</span><span class="p">.</span><span class="nf">AddAuthorization</span><span class="p">(</span><span class="n">options</span> <span class="p">=&gt;</span>
<span class="p">{</span>
  <span class="n">options</span><span class="p">.</span><span class="nf">AddPolicy</span><span class="p">(</span><span class="s">"StaffRead"</span><span class="p">,</span> <span class="n">policy</span> <span class="p">=&gt;</span> <span class="n">policy</span><span class="p">.</span><span class="nf">RequireClaim</span><span class="p">(</span><span class="n">JwtClaimTypes</span><span class="p">.</span><span class="n">Scope</span><span class="p">,</span> <span class="s">"staffApi.read"</span><span class="p">));</span>
  <span class="n">options</span><span class="p">.</span><span class="nf">AddPolicy</span><span class="p">(</span><span class="s">"Staff"</span><span class="p">,</span> <span class="n">policy</span> <span class="p">=&gt;</span> <span class="n">policy</span><span class="p">.</span><span class="nf">RequireClaim</span><span class="p">(</span><span class="n">JwtClaimTypes</span><span class="p">.</span><span class="n">Scope</span><span class="p">,</span> <span class="s">"staffApi.read"</span><span class="p">,</span><span class="s">"staffApi.write"</span><span class="p">));</span>
<span class="p">});</span>
</pre></table></code></div></div><div class="language-csharp highlighter-rouge"><div class="code-header"> <span text-data=" C# "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="p">[</span><span class="nf">Authorize</span><span class="p">(</span><span class="n">Policy</span> <span class="p">=</span><span class="s">"Staff"</span><span class="p">)]</span>
</pre></table></code></div></div><ol><li><p>AddJwtBearer</p><p>AddJwtBearer 从header中提取和验证jwt token</p><li><p>client credential grant 客户端授权将无法获取userinfo，返回Forbidden <a href="https://stackoverflow.com/questions/54145970/get-userinfo-from-access-token-forbidden">Get UserInfo from Access Token - “Forbidden”</a></p><li><p>client credentials 授权时利用Client中的claim中的role结合Policy限制访问，但不建议，应采用 Policy-Base 比较适合。</p></ol><p>claim 针对用户的信息，键值对。</p><p>scope 针对token 可以访问的范围</p><p>role 针对user identity 的信息</p><p>所以下面的方案并不适合客户端授权</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span text-data=" C# "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre>  <span class="k">new</span> <span class="n">Client</span>
     <span class="p">{</span>
         <span class="n">ClientId</span> <span class="p">=</span> <span class="s">"x"</span><span class="p">,</span>
         <span class="n">ClientName</span> <span class="p">=</span> <span class="s">"x Api"</span><span class="p">,</span>
         <span class="n">AllowedGrantTypes</span> <span class="p">=</span> <span class="n">GrantTypes</span><span class="p">.</span><span class="n">ClientCredentials</span><span class="p">,</span>
         <span class="n">ClientSecrets</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Secret</span><span class="p">&gt;</span> <span class="p">{</span><span class="k">new</span> <span class="nf">Secret</span><span class="p">(</span><span class="s">"xxx"</span><span class="p">.</span><span class="nf">Sha256</span><span class="p">())},</span>
         <span class="n">AllowedScopes</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="p">{</span>
             <span class="s">"staffApi.read"</span><span class="p">},</span>
         <span class="n">Claims</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">ClientClaim</span><span class="p">&gt;{</span> <span class="k">new</span> <span class="nf">ClientClaim</span><span class="p">(</span><span class="n">JwtClaimTypes</span><span class="p">.</span><span class="n">Role</span><span class="p">,</span> <span class="s">"Staff"</span><span class="p">)</span> <span class="p">}</span>
     <span class="p">},</span>
</pre></table></code></div></div><div class="language-csharp highlighter-rouge"><div class="code-header"> <span text-data=" C# "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre> <span class="n">options</span><span class="p">.</span><span class="nf">AddPolicy</span><span class="p">(</span><span class="s">"Staff"</span><span class="p">,</span> <span class="n">policy</span> <span class="p">=&gt;</span> <span class="n">policy</span><span class="p">.</span><span class="nf">RequireClaim</span><span class="p">(</span><span class="s">"client_role"</span><span class="p">,</span> <span class="s">"Staff"</span><span class="p">));</span>
</pre></table></code></div></div><ol><li>在不同局域/DNS的部署Identity和其他服务，出现 The remote certificate is invalid according to the validation procedure: RemoteCertificateNameMismatch</ol><p>参考 <a href="https://stackoverflow.com/questions/68268568/c-sharp-the-remote-certificate-is-invalid-according-to-the-validation-procedure">RemoteCertificateNameMismatch</a></p><blockquote><p>I suspect that remote certificate is issued against some DNS name, but you are connecting to IP address which apparently isn’t specified in certificate subject/SAN extension.</p></blockquote><ol><li>返回200，但无内容</ol><p>在ExceptionMiddleware 中错误被拦截，context.status = 200</p><p>内部报错： The MetadataAddress or Authority must use HTTPS unless disabled for development by setting RequireHttpsMetadata=false.</p><p>只用于开发环境</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span text-data=" C# "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="p">.</span><span class="nf">AddJwtBearer</span><span class="p">(</span><span class="s">"Bearer"</span><span class="p">,</span> <span class="n">options</span> <span class="p">=&gt;</span>
           <span class="p">{</span>
               <span class="n">options</span><span class="p">.</span><span class="n">Authority</span> <span class="p">=</span> <span class="n">Configuration</span><span class="p">.</span><span class="nf">GetSection</span><span class="p">(</span><span class="s">"Identity"</span><span class="p">)[</span><span class="s">"Authority"</span><span class="p">];</span>

               <span class="c1">//This should be disabled only in development environments</span>
               <span class="n">options</span><span class="p">.</span><span class="n">RequireHttpsMetadata</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
            <span class="p">}</span>
</pre></table></code></div></div><h2 id="6-参考">6. 参考</h2><p><a href="https://codewithmukesh.com/blog/identityserver4-in-aspnet-core/">IdentityServer4 in ASP.NET Core – Ultimate Beginner’s Guide</a></p><p><a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/scenario-protected-web-api-verification-scope-app-roles?tabs=aspnetcore">Protected web API: Verify scopes and app roles</a></p><p><a href="https://docs.microsoft.com/en-us/aspnet/core/security/authorization/roles?view=aspnetcore-6.0">Role-based authorization in ASP.NET Core</a></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/aspnetcore/'>AspnetCore</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/auth/" class="post-tag no-text-decoration" >auth</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> 本文由作者按照 <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> 进行授权</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">分享</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=AspnetCore Authorize - zengxiangqiu&url=https://zengxiangqiu.github.io/posts/AspnetCore-Authorize/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=AspnetCore Authorize - zengxiangqiu&u=https://zengxiangqiu.github.io/posts/AspnetCore-Authorize/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=AspnetCore Authorize - zengxiangqiu&url=https://zengxiangqiu.github.io/posts/AspnetCore-Authorize/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="分享链接" title-succeed="链接已复制！"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>最近更新</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/Docker/">Docker</a><li><a href="/posts/window-commands/">window commands</a><li><a href="/posts/kubernetes-install/">kubernetes install</a><li><a href="/posts/MySQL/"> MySQL</a><li><a href="/posts/kubernetes-mysql/">kubernetes mysql</a></ul></div><div id="access-tags"> <span>热门标签</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/%E5%B7%A5%E5%85%B7/">工具</a> <a class="post-tag" href="/tags/k8s/">k8s</a> <a class="post-tag" href="/tags/redis/">redis</a> <a class="post-tag" href="/tags/%E6%B5%8B%E8%AF%95/">测试</a> <a class="post-tag" href="/tags/database/">database</a> <a class="post-tag" href="/tags/deployment/">Deployment</a> <a class="post-tag" href="/tags/ef/">ef</a> <a class="post-tag" href="/tags/httpclient/">httpclient</a> <a class="post-tag" href="/tags/js/">js</a> <a class="post-tag" href="/tags/linq/">linq</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">文章内容</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>相关文章</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/AspnetCore-profile/"><div class="card-body"> <span class="timeago small" >2021-12-20<i class="unloaded">2021-12-20T11:52:29+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>AspnetCore Middleware Components</h3><div class="text-muted small"><p> service services.Add{GROUP_NAME} 添加服务 DI lifetimes Transient Scoped （DbContext） Singleton 注意： 不要从单例服务 中解析范围 服务 Dependency injection in .NET middleware 重点：pipeline USE 结合next.invo...</p></div></div></a></div><div class="card"> <a href="/posts/AspnetCore-Middleware-Redis/"><div class="card-body"> <span class="timeago small" >2021-12-20<i class="unloaded">2021-12-20T17:19:49+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>AspnetCore Middleware Redis</h3><div class="text-muted small"><p> 1. 命名惯例 Yes, colon sign : is a convention when naming keys. In this tutorial on redis website is stated: Try to stick with a schema. For instance “object-type:id:field” can be a nice idea, like in...</p></div></div></a></div><div class="card"> <a href="/posts/AspnetCore-Database/"><div class="card-body"> <span class="timeago small" >2021-12-21<i class="unloaded">2021-12-21T12:12:25+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>AspnetCore Database</h3><div class="text-muted small"><p> 1. 分离迁移项目 services.AddDbContext&lt;lsj50Context&gt;( options =&gt; { options.UseMySQL(Configuration.GetConnectionString("mysqlConnection"),x=&gt;x.MigrationsAssembly("Infrastructur...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/DotnetCore-CLI/" class="btn btn-outline-primary" prompt="上一篇"><p>DotnetCore CLI</p></a> <a href="/posts/AspnetCore-Testing/" class="btn btn-outline-primary" prompt="下一篇"><p>AspnetCore Testing</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://twitter.com/username">zengxiangqiu</a>. <span data-toggle="tooltip" data-placement="top" title="除非另有说明，本网站上的博客文章均由作者按照知识共享署名 4.0 国际 (CC BY 4.0) 许可协议进行授权。">保留部分权利。</span></p></div><div class="footer-right"><p class="mb-0"> 本站由 <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> 生成，采用 <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> 主题。</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">热门标签</h4><a class="post-tag" href="/tags/%E5%B7%A5%E5%85%B7/">工具</a> <a class="post-tag" href="/tags/k8s/">k8s</a> <a class="post-tag" href="/tags/redis/">redis</a> <a class="post-tag" href="/tags/%E6%B5%8B%E8%AF%95/">测试</a> <a class="post-tag" href="/tags/database/">database</a> <a class="post-tag" href="/tags/deployment/">Deployment</a> <a class="post-tag" href="/tags/ef/">ef</a> <a class="post-tag" href="/tags/httpclient/">httpclient</a> <a class="post-tag" href="/tags/js/">js</a> <a class="post-tag" href="/tags/linq/">linq</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">搜索结果为空</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script>
