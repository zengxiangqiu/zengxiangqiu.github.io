<!DOCTYPE html><html lang="zh-CN" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="天前"><meta name="hour-prompt" content="小时前"><meta name="minute-prompt" content="分钟前"><meta name="justnow-prompt" content="刚刚"><meta name="generator" content="Jekyll v4.3.4" /><meta property="og:title" content="kubernetes install" /><meta property="og:locale" content="zh_CN" /><meta name="description" content="kubectl" /><meta property="og:description" content="kubectl" /><link rel="canonical" href="https://zengxiangqiu.github.io/posts/kubernetes-install/" /><meta property="og:url" content="https://zengxiangqiu.github.io/posts/kubernetes-install/" /><meta property="og:site_name" content="zengxiangqiu" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-11-07T11:59:04+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="kubernetes install" /><meta name="twitter:site" content="@zengxiangqiu" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2024-11-08T15:01:53+08:00","datePublished":"2022-11-07T11:59:04+08:00","description":"kubectl","headline":"kubernetes install","mainEntityOfPage":{"@type":"WebPage","@id":"https://zengxiangqiu.github.io/posts/kubernetes-install/"},"url":"https://zengxiangqiu.github.io/posts/kubernetes-install/"}</script><title>kubernetes install | zengxiangqiu</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="zengxiangqiu"><meta name="application-name" content="zengxiangqiu"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="zh-CN"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> </a></div><div class="site-title mt-3"> <a href="/">zengxiangqiu</a></div><div class="site-subtitle font-italic">知识库</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>首页</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>分类</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>标签</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>归档</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>关于</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/zengxiangqiu" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/zengxiangqiu" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['example','doamin.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> 首页 </a> </span> <span>kubernetes install</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> 文章</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="搜索..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >取消</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>kubernetes install</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> zengxiangqiu </span> 发表于 <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="2022-11-07, 11:59 +0800" >2022-11-07<i class="unloaded">2022-11-07T11:59:04+08:00</i> </span></div><div> <span> 更新于 <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="2024-11-08, 15:01 +0800" >11-08<i class="unloaded">2024-11-08T15:01:53+08:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="4865 字">27 分钟 阅读</span></div></div><div class="post-content"><h2 id="kubectl">kubectl</h2><p>常见命令</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
</pre><td class="rouge-code"><pre><span class="c">#集群健康</span>
kubectl get cs
<span class="c">#创建deployment 以及service</span>
kubectl create deployment demo <span class="nt">--image</span><span class="o">=</span>httpd <span class="nt">--port</span><span class="o">=</span>80
kubectl expose deploy  <span class="o">[</span>deployName]  <span class="nt">--name</span><span class="o">=</span>xxx <span class="nt">--type</span><span class="o">=</span>NodePort
<span class="c">#services Endpoints</span>
kubectl get svc,ep
<span class="c">#重启depolyment</span>
kubectl rollout restart deployment nginx-deployment
<span class="c">#标签，日志输出</span>
kubectl logs <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>lsd-inventory <span class="nt">-n</span> lesaunda
<span class="c">#以机器可读的方式列举隶属于某 Job 的全部 Pod</span>
<span class="nv">pods</span><span class="o">=</span><span class="si">$(</span>kubectl get pods <span class="nt">--selector</span><span class="o">=</span>job-name<span class="o">=</span>pi <span class="nt">--output</span><span class="o">=</span><span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.items[*].metadata.name}'</span><span class="si">)</span>
<span class="nb">echo</span> <span class="nv">$pods</span>
kubectl logs <span class="nv">$pods</span>
<span class="c"># scale deployment</span>
kubectl scale deployment/xxxx <span class="nt">--replicas</span><span class="o">=</span>5 <span class="nt">-n</span> lesaunda
<span class="c"># find out default namespace</span>
kubectl config view <span class="nt">--minify</span> <span class="nt">--output</span> <span class="s1">'jsonpath={..namespace}'</span><span class="p">;</span> <span class="nb">echo</span>
<span class="c"># set default namespace</span>
kubectl config set-context <span class="nt">--current</span> <span class="nt">--namespace</span><span class="o">=</span>&lt;NAME&gt;
<span class="c"># restart daemonset</span>
kubectl rollout restart  daemonset filebeat <span class="nt">-n</span> kube-system
kubectl rollout status ds/filebeat <span class="nt">-n</span> kube-system

kubectl create configmap xx_config <span class="nt">--from-file</span><span class="o">=</span>.env
<span class="c"># copy configmap</span>
kubectl get configmap &lt;secret-name&gt; <span class="nt">--namespace</span><span class="o">=</span>&lt;source-namespace&gt; <span class="nt">-o</span> yaml <span class="se">\</span>
  | <span class="nb">sed</span> <span class="s1">'s/namespace: &lt;from-namespace&gt;/namespace: &lt;to-namespace&gt;/'</span> <span class="se">\</span>
  | kubectl create <span class="nt">-f</span> -
<span class="c"># Let’s check for the expiration date of a specific certificate</span>
openssl x509 <span class="nt">-in</span> /etc/kubernetes/pki/apiserver.crt <span class="nt">-noout</span> <span class="nt">-text</span> | <span class="nb">grep</span> <span class="s1">'Not After'</span>
find /etc/kubernetes/pki/ <span class="nt">-type</span> f <span class="nt">-name</span> <span class="s2">"*.crt"</span> <span class="nt">-print</span> | <span class="nb">grep</span> <span class="nt">-v</span> <span class="s1">'ca.crt$'</span> | xargs <span class="nt">-L</span> 1 <span class="nt">-t</span> <span class="nt">-i</span> bash <span class="nt">-c</span> <span class="s1">'openssl x509 -noout -text -in {} | grep "Not After"'</span>
kubeadm certs check-expiration
kubeadm certs renew all
<span class="c"># After renewing the certificates, we need to restart the control plane components, including the API server, controller manager, and scheduler, to use the new certificates.</span>
<span class="nv">$ </span><span class="nb">sudo </span>systemctl restart kubelet

<span class="nv">$ </span>kubectl <span class="nt">-n</span> seatunnel <span class="nb">cp</span> ./xxx.jar seatunnel-0:/opt/seatunnel/lib <span class="nt">-c</span> seatunnel
<span class="c"># remove all evicted pods</span>
kubectl get pod <span class="nt">-n</span> airflow| <span class="nb">grep </span>Evicted | <span class="nb">awk</span> <span class="s1">'{print $1}'</span> | xargs kubectl delete pod <span class="nt">-n</span> airflow
</pre></table></code></div></div><h2 id="yaml-block">yaml block</h2><ol><li>hostAliases ```yaml hostAliases:<ul><li>ip: “192.168.1.10” hostnames:</ul><ul><li>“foo.local”<li>“bar.local” ```</ul><li><p>localhost:8080 was refused</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>docker ps | <span class="nb">grep </span>kube-apiserver

<span class="nb">mkdir</span> <span class="nt">-p</span> <span class="nv">$HOME</span>/.kube
<span class="nb">sudo cp</span> <span class="nt">-i</span> /etc/kubernetes/admin.conf <span class="nv">$HOME</span>/.kube/config
<span class="nb">sudo chown</span> <span class="si">$(</span><span class="nb">id</span> <span class="nt">-u</span><span class="si">)</span>:<span class="si">$(</span><span class="nb">id</span> <span class="nt">-g</span><span class="si">)</span> <span class="nv">$HOME</span>/.kube/config
</pre></table></code></div></div><p>参考<a href="https://discuss.kubernetes.io/t/the-connection-to-the-server-localhost-8080-was-refused-did-you-specify-the-right-host-or-port/1464">The connection to the server localhost:8080 was refused - did you specify the right host or port?</a></p></ol><h2 id="kubeadm">kubeadm</h2><h3 id="kubeadm-init">kubeadm init</h3><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="c"># centos</span>
<span class="nb">sudo </span>yum <span class="nb">install </span>kubelet-1.25.3  kubeadm-1.25.3  kubectl-1.25.3 <span class="nt">--nogpgcheck</span> <span class="nt">-y</span>

<span class="c"># ubuntu</span>
<span class="nb">sudo </span>apt-get update
<span class="nb">sudo </span>apt-get <span class="nb">install</span> <span class="nt">-y</span>  apt-transport-https ca-certificates
curl <span class="nt">-fsSL</span> https://packages.cloud.google.com/apt/doc/apt-key.gpg | <span class="nb">sudo </span>gpg <span class="nt">--dearmor</span> <span class="nt">-o</span> /etc/apt/keyrings/kubernetes-archive-keyring.gpg
curl <span class="nt">-s</span> https://packages.cloud.google.com/apt/doc/apt-key.gpg | <span class="nb">sudo </span>apt-key add
<span class="nb">sudo </span>apt <span class="nb">install</span> <span class="nt">-y</span> <span class="nv">kubelet</span><span class="o">=</span>1.25.3-00  <span class="nv">kubeadm</span><span class="o">=</span>1.25.3-00  <span class="nv">kubectl</span><span class="o">=</span>1.25.3-00
</pre></table></code></div></div><p>为了保证 kubelet 正常工作，你必须禁用交换分区,关闭 selinux 与防火墙,配置 kubernetes /etc/modules-load.d/k8s.conf</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>kubeadm init <span class="se">\</span>
<span class="nt">--kubernetes-version</span><span class="o">=</span>v1.25.3 <span class="se">\</span>
<span class="nt">--image-repository</span><span class="o">=</span>registry.aliyuncs.com/google_containers <span class="se">\</span>
<span class="nt">--pod-network-cidr</span><span class="o">=</span>10.244.0.0/16   <span class="se">\</span>
<span class="nt">--control-plane-endpoint</span><span class="o">=</span>kube-apiserver <span class="se">\</span>
<span class="nt">--cri-socket</span> unix:///run/containerd/containerd.sock <span class="se">\</span>
<span class="nt">--v</span><span class="o">=</span>5
</pre></table></code></div></div><p>kubeadm init 之前存在给定的证书和私钥对，kubeadm 将不会重写它们</p><p>Kubeadm 对集群所有的节点，使用相同的 KubeletConfiguration</p><p>执行 init、join 和 upgrade 等子命令会促使 kubeadm 将 KubeletConfiguration 写入到文件 /var/lib/kubelet/config.yaml 中， 继而把它传递给本地节点的 kubelet。</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>kubeadm certs check-expiration
</pre></table></code></div></div><p>kubeadm 将 kubelet 配置为自动更新证书</p><h3 id="kubeadm-join">kubeadm join</h3><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre><td class="rouge-code"><pre><span class="c"># 生成加入集群命令</span>
kubeadm token create <span class="nt">--print-join-command</span>

<span class="c"># 加入集群</span>
kubeadm <span class="nb">join </span>kube-apiserver:6443 <span class="se">\</span>
<span class="nt">--token</span> i7guj6.at1q41k4bdgi0gbg <span class="se">\</span>
<span class="nt">--discovery-token-ca-cert-hash</span> sha256:fc2a4732767762ea293ff2c6da67162bcc27e9850fc4919e769b0215c300d856 <span class="se">\</span>
<span class="nt">--cri-socket</span> unix:///run/containerd/containerd.sock <span class="se">\</span>
<span class="nt">--v</span><span class="o">=</span>8

<span class="c"># ubuntu 16.04  kubernetes v1.25.3 需要 install cri-dockerd --cri-socket /run/cri-dockerd.sock</span>


<span class="c"># 将控制平面证书（ca, etcd, api....）上传到集群，并下载解密key</span>
kubeadm init phase upload-certs <span class="nt">--upload-certs</span> <span class="nt">--v</span><span class="o">=</span>5

<span class="c"># -certificate-key 下载并解密</span>
kubeadm <span class="nb">join </span>kube-apiserver:6443 <span class="se">\</span>
<span class="nt">--token</span> 0q5r70.53fggw68nta4697x <span class="se">\</span>
<span class="nt">--discovery-token-ca-cert-hash</span> sha256:fc2a4732767762ea293ff2c6da67162bcc27e9850fc4919e769b0215c300d856 <span class="se">\</span>
<span class="nt">--certificate-key</span> 27f45c69543808830fb2c59c2dd110a7e010766dd1e5a1ea9a956ef58a194bd0 <span class="se">\</span>
<span class="nt">--cri-socket</span> unix:///run/containerd/containerd.sock <span class="se">\</span>
<span class="nt">--control-plane</span> <span class="se">\</span>
<span class="nt">--v</span><span class="o">=</span>8

</pre></table></code></div></div><h3 id="问题汇总">问题汇总</h3><ul><li><p>pull image</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>kubeadm config images list
kubeadm config images pull <span class="nt">--cri-socket</span><span class="o">=</span>unix:///run/containerd/containerd.sock <span class="nt">--image-repository</span><span class="o">=</span>registry.aliyuncs.com/google_containers <span class="nt">--kubernetes-version</span><span class="o">=</span>v1.25.3
</pre></table></code></div></div><li><p>cri sandbox image pause</p><p>pod 所有容器的父容器 kubelet call runsandbox 和 linux namespace 以及 cgroup 申领 network namespace等相关资源配额,pause start 之后将一直阻塞,remove pause first and remove containers in it.</p><p>cri 比如 containerd 以哪个版本的pause作为sandbox可在<code class="language-plaintext highlighter-rouge">/etc/containerd/config.toml</code>中设置sandbox_image, default <code class="language-plaintext highlighter-rouge">registry.k8s.io/pause</code></p><p><code class="language-plaintext highlighter-rouge">systemctl status kubelet</code> 状态 Actived，正常，如 InActivce, <code class="language-plaintext highlighter-rouge">systemctl enable kubelet</code></p><p><code class="language-plaintext highlighter-rouge">journalctl -xeu kubectl --no-pager</code> 查看日志，发现<code class="language-plaintext highlighter-rouge">failed to pull image [registry.k8s.io/pause:3.6 -o pause.tar]</code></p><p>拉取，tag，import</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>crictl images
docker pull registry.aliyuncs.com/google_containers/pause:3.6
docker tag registry.aliyuncs.com/google_containers/pause:3.6 registry.k8s.io/pause:3.6
docker save registry.k8s.io/pause:3.6 <span class="nt">-o</span> pause.tar
ctr <span class="nt">-n</span> k8s.io  images import pause.tar
ctr <span class="nt">-n</span> k8s.io i tag registry.aliyuncs.com/google_containers/pause:3.6 registry.k8s.io/pause:3.6
</pre></table></code></div></div><li><p>failed to reserve sandbox name</p><p>apiserver 访问 container runtime interface 失败</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>vim /etc/containerd/config.toml

<span class="c"># disabled_plugins = ["cri"]</span>

systemctl daemon-reload
systemctl  restart containerd
</pre></table></code></div></div><li><p>kubelet invalid slice name</p><p><a href="https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet/">kubelet configuration</a></p><blockquote><p>–cgroup-driver string Default: cgroupfs</p></blockquote><p>查看 <code class="language-plaintext highlighter-rouge">/var/lib/kubelet/config.yaml</code></p><blockquote><p>cgroupDriver: systemd</p></blockquote><p>查看 <code class="language-plaintext highlighter-rouge">/etc/containerd/config.toml</code> 或 <code class="language-plaintext highlighter-rouge">containerd config default</code></p><blockquote><p>systemd_cgroup = false</p></blockquote><p>改为true, restart containerd</p><p>如使用 docker + cri-dockerd 配置cgroupfs，查看<code class="language-plaintext highlighter-rouge">/etc/docker/daemon.json</code></p><div class="language-json highlighter-rouge"><div class="code-header"> <span text-data=" JSON "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"exec-opts"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"native.cgroupdriver=cgroupfs"</span><span class="p">],</span><span class="w">
  </span><span class="nl">"insecure-registries"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"registry.xxxx.com.cn"</span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><p>restart docker,kubelet</p><li><p>alter node Role</p><p><code class="language-plaintext highlighter-rouge">kubectl get no master -o wide --show-labels</code></p><p><code class="language-plaintext highlighter-rouge">kubectl get nodes</code></p><p><code class="language-plaintext highlighter-rouge">kubectl label no ubuntucache-srv node-role.kubernetes.io/control-plane=</code></p><p>参考<a href="https://blog.csdn.net/Lingoesforstudy/article/details/116484624">k8s 中节点 node 的 ROLES 值是 none</a></p><li><p>/proc/sys/net/bridge/bridge-nf-call-iptables contents are not set to 1</p><p>执行<code class="language-plaintext highlighter-rouge">echo "1" &gt;/proc/sys/net/bridge/bridge-nf-call-iptables</code></p><p>提示 No such file or directory, 没有 bridge folder ，要enable br_netfilter <code class="language-plaintext highlighter-rouge">modprobe br_netfilter</code>， 再 <code class="language-plaintext highlighter-rouge">sysctl net.bridge.bridge-nf-call-iptables=1</code>， 同样 <code class="language-plaintext highlighter-rouge">sysctl net.ipv4.ip_forward=1</code></p><li><p>kubeadm join –control-plane lack of etcd</p><p><a href="https://kubernetes.io/zh-cn/docs/reference/setup-tools/kubeadm/kubeadm-join/#join-workflow">工作流</a></p><p>加入节点有两种方式</p><ol><li>节点发现 （-token + -discovery-token-ca-cert-has + api：port）</ol><p><code class="language-plaintext highlighter-rouge">token</code> 为共享令牌，<code class="language-plaintext highlighter-rouge">-discovery-token-ca-cert-has</code> 为验证master ca证书 是否一致（–discovery-token-unsafe-skip-ca-verification 跳过，不建议）， 验证通过后将建立tls引导，提交CSR，签名，控制面返回确定标识，kubeadm 配置kubelet ，通信</p><p>如果是加入控制面， 下载共享证书+ 静态pod清单+ kubeconfig +etcd</p><ol><li>以文件形式提供标准 kubeconfig 文件的一个子集</ol><p>分段执行</p><p><code class="language-plaintext highlighter-rouge">kubeadm join phase kubelet-start --config=config,yaml</code></p><p><code class="language-plaintext highlighter-rouge">kubeadm join phase kubelet-start --token=xx -discovery-token-ca-cert-has=xxxx</code></p><p>如果使用 –upload-certs 调用 kubeadm init 命令， 你也可以对控制平面节点调用带 –certificate-key 参数的 join 命令， 将证书复制到该节点。</p><li><p>failed to publish local member to cluster through raft</p><p>disable firewall</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="c"># ubuntu</span>
<span class="nb">sudo </span>ufw disable

<span class="c"># centos</span>
systemctl stop firewalld.service
</pre></table></code></div></div><li><p>kubeadm reset , Failed to unmount mounted directory in /var/lib/kubelet/</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>umount &lt;path&gt;
<span class="nb">rm</span> <span class="nt">-rf</span> &lt;filePath&gt;
</pre></table></code></div></div><li><p>cert</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>openssl genrsa <span class="nt">-out</span> ca.key 2048
openssl req <span class="nt">-x509</span> <span class="nt">-new</span> <span class="nt">-nodes</span> <span class="nt">-key</span> ca.key <span class="nt">-subj</span> <span class="s2">"/CN=kube-apiserver"</span> <span class="nt">-days</span> 10000 <span class="nt">-out</span> ca.crt
openssl genrsa <span class="nt">-out</span> server.key 2048
</pre></table></code></div></div></ul><h2 id="coredns">CoreDNS</h2><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>kubectl run <span class="nt">-it</span> <span class="nt">--image</span><span class="o">=</span>busybox:1.28.3 <span class="nt">--rm</span> <span class="nt">--restart</span><span class="o">=</span>Never bash <span class="nt">-n</span> kube-system
nslookup  kubernetes.default

:: no server could be reached.

kubectl get ep kube-dns <span class="nt">-n</span> kube-system <span class="nt">-o</span> json |jq <span class="nt">-r</span> <span class="s2">".subsets"</span>
</pre></table></code></div></div><p>coredns 服务/pod 正常，但创建的 pod 无法 nslook 服务，coredns configmap 加 log 也检测不到，反而 master node 上<code class="language-plaintext highlighter-rouge">dig @10.96.0.10 kubernetes.default.svc.cluster.local +noall +answer</code> 可以找到域名的 ip,无果，删除 dns pod 后自动创建，恢复正常。怀疑与期间修改 flannel subnet 文件以及 cni0 网络相关,尝试 改 ipv4 允许转发,busybox image 应&lt;=1.28.3, 大于此版本可能出现 No Answer 问题</p><p>2023-05-23 补充，node2 存在多个 bridge network, ping 192.168.20.xx 时 出现</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>ping 192.168.20.xx

From 192.168.16.1 icmp <span class="nb">seq</span> <span class="o">=</span>1  destination host unreachable
From 192.168.16.1 icmp <span class="nb">seq</span> <span class="o">=</span>1  destination host unreachable
</pre></table></code></div></div><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre><td class="rouge-code"><pre><span class="c"># 查看iptables 规则,没有发现异常</span>
iptables <span class="nt">-L</span> <span class="nt">-n</span>
iptables <span class="nt">--table</span> nat <span class="nt">--list</span>

<span class="c"># firewall status inactive</span>
systemctl status firewalld.service

<span class="c"># 安装bind_utils工具，包括nslookup, dig</span>
yum <span class="nb">install </span>bind_utils

<span class="c"># dig &lt;ip&gt;, nslookup ip</span>
1 node2 3000ms <span class="o">!</span>H

<span class="c"># ip a 或者 ifconfig 或 安装  bridge-utils, 看到bridge network 关联 192.168.16.1</span>
brctl show

<span class="c"># delete</span>
ip <span class="nb">link set</span> &lt;bridge_name&gt; down
ip <span class="nb">link </span>del &lt;bridge_name&gt;

<span class="c"># 或者nmcli</span>
nmcli con show
nmcli connecion down &lt;bridge_name&gt;

<span class="c"># ping ok</span>

<span class="c"># proxy 无法access kube-apiserver no such host , 8.8.8.8 resolv, 修改 本机和pod /etc/resolv.conf  重启会被自动覆盖</span>
<span class="c"># install resolvconf， 配置 /etc/resolvconf/resolv.conf.d/head亦无法修复此问题</span>
systemd-resolve <span class="nt">--status</span>
<span class="nb">sudo </span>systemctl status systemd-resolved.service
<span class="nb">sudo cat</span>  /run/systemd/resolve/resolv.conf
<span class="c"># 修改 resolved.conf</span>
<span class="nb">sudo </span>vim  /etc/systemd/resolved.conf
<span class="o">[</span>Resolve]
<span class="nv">FallbackDNS</span><span class="o">=</span>192.168.1.xxx 192.168.1.xxx
<span class="nv">Domains</span><span class="o">=</span>xxx.com.cn
</pre></table></code></div></div><h2 id="crictl">crictl</h2><p>参考<a href="https://kubernetes.io/zh-cn/docs/tasks/debug/debug-cluster/crictl/">使用 crictl 对 Kubernetes 节点进行调试</a></p><p>Install</p><div class="language-sh highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="nv">VERSION</span><span class="o">=</span><span class="s2">"v1.26.0"</span>
wget https://github.com/kubernetes-sigs/cri-tools/releases/download/<span class="nv">$VERSION</span>/crictl-<span class="nv">$VERSION</span><span class="nt">-linux-amd64</span>.tar.gz
<span class="nb">sudo tar</span> <span class="nt">-zxvf</span> crictl-<span class="nv">$VERSION</span><span class="nt">-linux-amd64</span>.tar.gz <span class="nt">-C</span> /usr/local/bin
<span class="nb">rm</span> <span class="nt">-f</span> crictl-<span class="nv">$VERSION</span><span class="nt">-linux-amd64</span>.tar.gz
</pre></table></code></div></div><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>crictl ps
crictl logs &lt;container_id&gt; 2&gt;filename
crictl images
crictl inspect <span class="o">[</span>container_id]
crictl inspecti <span class="o">[</span>image_id]
crictl inspectp <span class="o">[</span>pod_id]
ctr <span class="nt">--namespace</span><span class="o">=</span>k8s.io image tag  registry.aliyuncs.com/google_containers/pause:3.6 registry.k8s.io/pause:3.6
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">vim /etc/crictl.yaml</code></p><div class="language-json highlighter-rouge"><div class="code-header"> <span text-data=" JSON "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="err">runtime-endpoint:</span><span class="w"> </span><span class="err">unix:///run/containerd/containerd.sock</span><span class="w">
</span><span class="err">image-endpoint:</span><span class="w"> </span><span class="err">unix:///run/containerd/containerd.sock</span><span class="w">
</span><span class="err">timeout:</span><span class="w"> </span><span class="mi">0</span><span class="w">
</span><span class="err">debug:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="err">#调试</span><span class="w">
</span><span class="err">pull-image-on-create:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span><span class="err">disable-pull-on-run:</span><span class="w"> </span><span class="kc">false</span><span class="w">

</span></pre></table></code></div></div><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="nv">$ </span>crictl ps

I0605 14:56:16.720887  254196 util_unix.go:103] <span class="s2">"Using this endpoint is deprecated, please consider using full URL format"</span> <span class="nv">endpoint</span><span class="o">=</span><span class="s2">"/run/containerd/containerd.sock"</span> <span class="nv">URL</span><span class="o">=</span><span class="s2">"unix:///run/containerd/containerd.sock"</span>

<span class="nv">$ </span>crictl config <span class="nt">--set</span> runtime-endpoint<span class="o">=</span>unix:///run/containerd/containerd

</pre></table></code></div></div><h2 id="etcd">etcd</h2><p>由 kubeadm 生成证书，kube-scheduler 调度 kubelet create etcd static pod ,清单见<code class="language-plaintext highlighter-rouge">/etc/kubernetes/manifests/etcd.yaml</code></p><p>分段执行</p><p><code class="language-plaintext highlighter-rouge">kubeadm init phase etcd local --config=/tmp/${HOST0}/kubeadmcfg.yaml</code></p><p>config file 参考 <a href="https://kubernetes.io/docs/reference/config-api/kubeadm-config.v1beta3/#kubeadm-k8s-io-v1beta3-ClusterConfiguration">kubeadm Configuration</a></p><h3 id="etcdctl连接集群">etcdctl连接集群</h3><p>etcd拓扑结构分stacked(堆叠)和外部</p><p>stacked 即 control-plane + etcd，节省资源</p><p>donwload <a href="https://github.com/etcd-io/etcd/releases/tag/v3.5.9">etcdctl</a></p><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre><td class="rouge-code"><pre><span class="c"># 集群成员</span>
/tmp/etcd-download-test/etcdctl <span class="se">\</span>
<span class="nt">--endpoints</span><span class="o">=</span>172.21.14.2xx:2379,kube-apiserverx:2379 <span class="se">\</span>
<span class="nt">--cert</span> /etc/kubernetes/pki/etcd/peer.crt <span class="se">\</span>
<span class="nt">--key</span> /etc/kubernetes/pki/etcd/peer.key <span class="se">\</span>
<span class="nt">--cacert</span> /etc/kubernetes/pki/etcd/ca.crt <span class="se">\</span>
member list

<span class="c"># 集群健康</span>
/tmp/etcd-download-test/etcdctl <span class="se">\</span>
<span class="nt">--endpoints</span><span class="o">=</span>172.21.14.2xx:2379,kube-apiserverx:2379 <span class="se">\</span>
<span class="nt">--cert</span> /etc/kubernetes/pki/etcd/peer.crt <span class="se">\</span>
<span class="nt">--key</span> /etc/kubernetes/pki/etcd/peer.key <span class="se">\</span>
<span class="nt">--cacert</span> /etc/kubernetes/pki/etcd/ca.crt <span class="se">\</span>
endpoint health

<span class="c"># 移除成员</span>
/tmp/etcd-download-test/etcdctl <span class="se">\</span>
<span class="nt">--endpoints</span><span class="o">=</span>172.21.14.2xx:2379,kube-apiserverx:2379 <span class="se">\</span>
<span class="nt">--cert</span> /etc/kubernetes/pki/etcd/peer.crt <span class="se">\</span>
<span class="nt">--key</span> /etc/kubernetes/pki/etcd/peer.key <span class="se">\</span>
<span class="nt">--cacert</span> /etc/kubernetes/pki/etcd/ca.crt <span class="se">\</span>
member remove <span class="k">${</span><span class="nv">MEMBER_ID</span><span class="k">}</span>

<span class="c"># 添加成员</span>
/tmp/etcd-download-test/etcdctl <span class="se">\</span>
<span class="nt">--endpoints</span><span class="o">=</span>172.21.14.2xx:2379,kube-apiserverx:2379 <span class="se">\</span>
<span class="nt">--cert</span> /etc/kubernetes/pki/etcd/peer.crt <span class="se">\</span>
<span class="nt">--key</span> /etc/kubernetes/pki/etcd/peer.key <span class="se">\</span>
<span class="nt">--cacert</span> /etc/kubernetes/pki/etcd/ca.crt <span class="se">\</span>
member add <span class="k">${</span><span class="nv">hostname</span><span class="k">}</span> <span class="nt">--peer-urls</span><span class="o">=</span>https://<span class="k">${</span><span class="nv">ip</span><span class="k">}</span>:2380
</pre></table></code></div></div><p>join master 过程中出现 etcd 出现 no leader 问题 和 tls connecion refused ,与证书有关，不要轻易改动 /etc/kubernetes/pki 目录，改的话要先备份。</p><p>假设集群不健康，无法通过常规方式restart，可尝试命令行的方式单独run etcd as a new cluster,风险大</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="c"># Force to create a new one-member cluster.</span>
<span class="nt">--force-new-cluster</span> <span class="s1">'true'</span>
</pre></table></code></div></div><p>利用备份文件和 etcd.yaml 在 kubernetes 外重新搭建 etcd 实例,不验证 auth，apiserver 的 yaml 文件中 etc listen url 也相应改为 http://127.0.0.1:2379</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre>/tmp/etcd-download-test/etcd  <span class="se">\</span>
<span class="nt">--listen-client-urls</span><span class="o">=</span>http://127.0.0.1:2379   <span class="se">\</span>
<span class="nt">--advertise-client-urls</span><span class="o">=</span>http://127.0.0.1:2379  <span class="se">\</span>
<span class="nt">--client-cert-auth</span><span class="o">=</span><span class="nb">false</span> <span class="se">\</span>
<span class="nt">--peer-client-cert-auth</span><span class="o">=</span><span class="nb">false</span>  <span class="se">\</span>
<span class="nt">--name</span><span class="o">=</span>master <span class="se">\</span>
<span class="nt">--initial-cluster</span><span class="o">=</span><span class="nv">master</span><span class="o">=</span>http://127.0.0.1:2380 <span class="se">\</span>
<span class="nt">--initial-advertise-peer-urls</span><span class="o">=</span>http://127.0.0.1:2380  <span class="se">\</span>
<span class="nt">--data-dir</span><span class="o">=</span>/var/lib/etcd_bak <span class="se">\</span>
<span class="nt">--initial-cluster-state</span><span class="o">=</span>new <span class="se">\</span>
<span class="nt">--force-new-cluster</span><span class="o">=</span><span class="s1">'true'</span>
</pre></table></code></div></div><h3 id="参考">参考</h3><p><a href="https://kubernetes.io/zh-cn/docs/setup/production-environment/tools/kubeadm/setup-ha-etcd-with-kubeadm/">手动建 etcd 集群</a></p><p><a href="https://etcd.io/docs/v3.5/op-guide/configuration/">Configuration options</a></p><p><a href="https://etcd.io/docs/v3.5/tutorials/how-to-deal-with-membership/">How to Add and Remove Members</a></p><p><a href="https://github.com/etcd-io/etcd/releases/">如何安装 etcd 和 etcdctl</a></p><h2 id="runc">runc</h2><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>wget https://github.com/opencontainers/runc/releases/download/v1.1.4/runc.amd64
<span class="nb">sudo install</span> <span class="nt">-m</span> 755 runc.amd64 /usr/local/sbin/runc
</pre></table></code></div></div><h2 id="cni">cni</h2><p>容器运行时必须配置为加载所需的 CNI 插件，从而实现 Kubernetes 网络模型</p><p>docker default cni-plugin is bridge</p><p>查看 <code class="language-plaintext highlighter-rouge">/etc/cni/net.d/</code></p><h3 id="cni-plugin">cni-plugin</h3><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nb">sudo mkdir</span> <span class="nt">-p</span> /opt/cni/bin/
<span class="nb">sudo </span>wget https://github.com/containernetworking/plugins/releases/download/v1.1.1/cni-plugins-linux-amd64-v1.1.1.tgz
<span class="nb">sudo tar </span>Cxzvf /opt/cni/bin cni-plugins-linux-amd64-v1.1.1.tgz
</pre></table></code></div></div><ul><li><p>flannel plugin</p><p>install</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>curl <span class="nt">-o</span> kube-flannel.yml https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
kubectl apply <span class="nt">-f</span> kube-flannel.yml
docker pull quay.io/coreos/flannel:v0.14.0
kubectl apply <span class="nt">-f</span> kube-flannel.yml
</pre></table></code></div></div><p>k8s create daemonset in node,相当于install flannel-cni-plugin , 查看<code class="language-plaintext highlighter-rouge">/run/flannel/subnet.env</code>和<code class="language-plaintext highlighter-rouge">/etc/cni/net.d</code></p><blockquote><p>Flannel.1: overlay网络的设备，用来进行 vxlan 报文的处理（封包和解包）。不同node之间的pod数据流量都从overlay设备以隧道的形式发送到对端。</p></blockquote><blockquote><p>Cni0 :网桥设备，每创建一个pod都会创建一对 veth pair。其中一端是pod中的eth0，另一端是Cni0网桥中的端口（网卡）。Pod从网卡eth0发出的流量都会发送到Cni0网桥设备的端口（网卡）上。</p></blockquote><blockquote><p>pod发数据，发到cni0, 再到flannel，隧道形式发送对端flannel，flannel 解释数据 ，发cni0, 再到pod, <code class="language-plaintext highlighter-rouge">ip route</code>查看</p></blockquote><p>参考</p><p><a href="https://jimmysong.io/kubernetes-handbook/concepts/flannel.html">扁平网络 Flannel</a></p><p><a href="https://zhuanlan.zhihu.com/p/340747753">kubernetes之flannel 网络分析</a></p></ul><h3 id="问题汇总-1">问题汇总</h3><ul><li><p>open /run/flannel/subnet.env no such file or directory</p><p>新建 /run/flannel/subnet.env 文件</p><div class="language-json highlighter-rouge"><div class="code-header"> <span text-data=" JSON "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="err">FLANNEL_NETWORK=</span><span class="mf">10.244</span><span class="err">.</span><span class="mf">0.0</span><span class="err">/</span><span class="mi">16</span><span class="w">
</span><span class="err">FLANNEL_SUBNET=</span><span class="mf">10.244</span><span class="err">.</span><span class="mf">0.1</span><span class="err">/</span><span class="mi">24</span><span class="w">
</span><span class="err">FLANNEL_MTU=</span><span class="mi">1450</span><span class="w">
</span><span class="err">FLANNEL_IPMASQ=</span><span class="kc">true</span><span class="w">
</span></pre></table></code></div></div><p>kube-flannel pod 挂载了<code class="language-plaintext highlighter-rouge">/run/flannel</code> ，不同的 node，FLANNEL_SUBNET 会有所不同<code class="language-plaintext highlighter-rouge">10.244.1.1/24,10.244.2.1/24</code></p><li><p>k8s 安装 flannel 报错“node “master” pod cidr not assigned”</p><p>Kubeadm Init 的时候，没有增加 –pod-network-cidr 10.244.0.0/16</p><p>kubectl patch node gz-vmtest -p ‘{“spec”:{“podCIDR”:”10.244.5.0/16”}}’</p><li><p>apply pod 时出现 <code class="language-plaintext highlighter-rouge">failed to set bridge addr: "cni0" already has an IP address different from 10.244.1.1/24</code></p><p>del cni0 flannel1.1 ,stop &amp; remove kube-flannel pod, restart</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre> ifconfig cni0 down
 ifconfig flannel.1 down
 ip <span class="nb">link </span>delete cni0
 ip <span class="nb">link </span>delete flannel.1
 ifconfig cni0
 ifconfig flannel.1

 ip <span class="nb">link </span>add cni0 <span class="nb">type </span>bridge
 ip <span class="nb">link set </span>dev cni0 up
 ifconfig cni0 10.244.0.1
 ifconfig cni0 mtu 1450 up
</pre></table></code></div></div></ul><h2 id="cri-容器运行时">CRI 容器运行时</h2><p>kubelet 通过 cri-socket 调用 (早前dockershim 1.24后弃用，没有实现CRI标准)cri-dockerd/containerd create sandbox, run containers in it.</p><p>如果单独install containerd.io , 需install runc（cgroup 相关）以及 cni(k8s 有default )</p><h3 id="containerd">containerd</h3><p><code class="language-plaintext highlighter-rouge">containerd plugin ls</code> 列出 containerd 插件</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre>yum-config-manager <span class="nt">--add-repo</span> http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo

<span class="nb">sudo </span>yum <span class="nb">install </span>docker-ce docker-ce-cli containerd.io docker-compose-plugin

<span class="nb">sudo </span>yum <span class="nb">install </span>containerd

systemctl <span class="nb">enable </span>containerd

systemctl start containerd
</pre></table></code></div></div><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre>vim /etc/containerd/config.toml
注释,开放接口给kubelet创建管理container
<span class="c">#disabled_plugins = [“cri”]</span>
或者
<span class="nb">sudo sed</span> <span class="nt">-i</span> <span class="s1">'s/^disabled_plugins \=/\#disabled_plugins \=/g'</span> /etc/containerd/config.toml

sandbox_image <span class="o">=</span> <span class="s2">"registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.8"</span>   <span class="c"># 修改为阿里云镜像地址</span>
SystemdCgroup <span class="o">=</span> <span class="nb">true</span>                                                              <span class="c"># 使用systemd cgroup</span>

镜像
version <span class="o">=</span> 1

<span class="o">[</span>plugins]
  <span class="o">[</span>plugins.cri]
    <span class="o">[</span>plugins.cri.registry]
        <span class="o">[</span>plugins.cri.registry.mirrors]
          <span class="o">[</span>plugins.cri.registry.mirrors.<span class="s2">"registry.k8s.io"</span><span class="o">]</span>
            endpoint <span class="o">=</span> <span class="o">[</span><span class="s2">"https://registry.cn-hangzhou.aliyuncs.com/google_containers"</span><span class="o">]</span>
          <span class="o">[</span>plugins.cri.registry.mirrors.<span class="s2">"docker.io"</span><span class="o">]</span>
            endpoint <span class="o">=</span> <span class="o">[</span><span class="s2">"https://registry.cn-hangzhou.aliyuncs.com"</span><span class="o">]</span>

</pre></table></code></div></div><div class="language-yaml highlighter-rouge"><div class="code-header"> <span text-data=" YAML "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="s">version = </span><span class="m">2</span>

<span class="pi">[</span><span class="nv">plugins."io.containerd.grpc.v1.cri"</span><span class="pi">]</span>
  <span class="s">sandbox_image = "http://registry.aliyuncs.com/google_containers/pause:3.8"</span>
<span class="pi">[</span><span class="nv">plugins."io.containerd.grpc.v1.cri".registry</span><span class="pi">]</span>
  <span class="pi">[</span><span class="nv">plugins."io.containerd.grpc.v1.cri".registry.mirrors</span><span class="pi">]</span>
    <span class="pi">[</span><span class="nv">plugins."io.containerd.grpc.v1.cri".registry.mirrors."docker.io"</span><span class="pi">]</span>
      <span class="s">endpoint = ["https://registry.docker-cn.com"]</span>
    <span class="s">[plugins."io.containerd.grpc.v1.cri".registry.mirrors."registry.k8s.io"]</span>
      <span class="s">endpoint = ["http://registry.aliyuncs.com/google_containers"]</span>
    <span class="s">[plugins."io.containerd.grpc.v1.cri".registry.mirrors."registry.lesaunda.io"]</span>
      <span class="s">endpoint = ["http://192.168.1.193:5000"]</span>
</pre></table></code></div></div><p>containerd v1.2 前 使用 <a href="https://github.com/containerd/cri/blob/release/1.2/docs/registry.md">配置语法</a></p><p>1.3之后使用 <a href="https://github.com/containerd/containerd/blob/main/docs/cri/registry.md">配置语法</a></p><p>如阿里云timeout,参考<a href="https://www.cnblogs.com/boonya/p/15954368.html">这里</a>,改 http://hub-mirror.c.163.com</p><p><code class="language-plaintext highlighter-rouge">systemctl daemon-reload</code> <code class="language-plaintext highlighter-rouge">systemctl enable --now containerd</code> 守护进程 <code class="language-plaintext highlighter-rouge">systemctl restart containerd</code></p><h3 id="docker-engine">docker engine</h3><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre>vim /etc/docker/daemon.json

<span class="o">{</span>
  <span class="s2">"exec-opts"</span>: <span class="o">[</span><span class="s2">"native.cgroupdriver=systemd"</span><span class="o">]</span>,
  <span class="s2">"insecure-registries"</span>: <span class="o">[</span><span class="s2">"172.21.14.206:5000"</span><span class="o">]</span>,
  <span class="s2">"registry-mirrors"</span>: <span class="o">[</span><span class="s2">"https://hub-mirror.c.163.com"</span><span class="o">]</span>
<span class="o">}</span>

systemctl daemon-reload
systemctl restart docker
</pre></table></code></div></div><h2 id="dashboard">Dashboard</h2><p>安装</p><p><code class="language-plaintext highlighter-rouge">kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v2.7.0/aio/deploy/recommended.yaml</code></p><p>修改 service 成 nodeport，外网访问</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre>kubectl describe pod/kubernetes-dashboard

<span class="c">#Normal   Scheduled         42m                  default-scheduler  Successfully assigned kubernetes-dashboard/&gt;</span>
<span class="c">#kubernetes-dashboard-5c8bd6b59-xxvkk to node1</span>

kubectl cluster-info

Kubernetes control plane is running at https://kube-apiserver:6443
CoreDNS is running at https://kube-apiserver:6443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy

kubectl proxy

<span class="c"># node1-&gt; 172.21.14.208</span>
https://172.21.14.208:30423/#/login
</pre></table></code></div></div><p>参考<a href="https://github.com/kubernetes/dashboard/blob/master/docs/user/accessing-dashboard/README.md">Accessing Dashboard</a></p><ol><li><p>nodeport ,token 登陆</p><p>按<a href="https://cloud.tencent.com/developer/article/1919416">k8s 优秀的 web 管理界面-kubernetes Dashboard</a> apply</p><p><code class="language-plaintext highlighter-rouge">kubectl get secret -n kubernetes-dashboard</code> 没有找到 token</p><p>1.23 以上执行</p><p>创建 serviceaccount</p><p>```yaml apiVersion: v1 kind: ServiceAccount metadata: name: admin namespace: kubernetes-dashboard</p></ol><hr /><p>apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRoleBinding metadata: name: admin roleRef: apiGroup: rbac.authorization.k8s.io kind: ClusterRole name: cluster-admin subjects: - kind: ServiceAccount name: admin namespace: kubernetes-dashboard</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span text-data=" Plaintext "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre><td class="rouge-code"><pre>
   `kubectl -n kubernetes-dashboard create token admin` 生成 token
## 污点 node

查看节点污点

`kubectl get nodes -o=custom-columns=NodeName:.metadata.name,TaintKey:.spec.taints[*].key,TaintValue:.spec.taints[*].value,TaintEffect:.spec.taints[*].effect`

NodeName            TaintKey                                TaintValue   TaintEffect
gz-k8ssrv-master1   &lt;none&gt;                                  &lt;none&gt;       &lt;none&gt;
lsd-server-01       &lt;none&gt;                                  &lt;none&gt;       &lt;none&gt;
node1               node-role.kubernetes.io/control-plane   &lt;none&gt;       NoSchedule
node2               node-role.kubernetes.io/control-plane   &lt;none&gt;       NoSchedule
ubuntucache-srv     node-role.kubernetes.io/control-plane   &lt;none&gt;       NoSchedule

`kubernetes 提示 1 node(s) had taints that the pod didn't tolerate` 表示 节点污点，pod不能容忍，所以不部署在此节点

&gt; NoSchedule,The Kubernetes scheduler will only allow scheduling pods that have tolerations for the tainted nodes.
&gt; PreferNoSchedule,The Kubernetes scheduler will try to avoid scheduling pods that don’t have tolerations for the tainted nodes.
&gt; NoExecute,Kubernetes will evict the running pods from the nodes if the pods don’t have tolerations for the tainted nodes.


```bash
kubectl taint nodes node1 key1=value1:NoSchedule
# remove
kubectl taint nodes node1 key1=value1:NoSchedule-
</pre></table></code></div></div><div class="language-yaml highlighter-rouge"><div class="code-header"> <span text-data=" YAML "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Pod</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">nginx</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">env</span><span class="pi">:</span> <span class="s">test</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">containers</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">nginx</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">nginx</span>
    <span class="na">imagePullPolicy</span><span class="pi">:</span> <span class="s">IfNotPresent</span>
  <span class="na">tolerations</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">key</span><span class="pi">:</span> <span class="s2">"</span><span class="s">example-key"</span>
    <span class="na">operator</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Exists"</span>
    <span class="na">effect</span><span class="pi">:</span> <span class="s2">"</span><span class="s">NoSchedule"</span>
</pre></table></code></div></div><p>pod 将在 存在污点 key=example-key 而且 effect = NoSchedule 的节点上部署</p><p>operator 的默认值是 Equal</p><p><code class="language-plaintext highlighter-rouge">kubectl taint nodes --all node-role.kubernetes.io/master-</code></p><p><code class="language-plaintext highlighter-rouge">kubectl label nodes ubuntucache-srv node.kubernetes.io/exclude-from-external-load-balancers=</code></p><p><code class="language-plaintext highlighter-rouge">kubectl taint node ubuntucache-srv node-role.kubernetes.io/control-plane=:NoSchedule</code></p><p>非体面关闭时 ，statefulSet 无法创建同名pod，要手动添加污点，分离卷操作</p><p><code class="language-plaintext highlighter-rouge">kubectl taint node ubuntucache-srv node.kubernetes.io/out-of-service=:NoSchedule</code></p><p>在添加 node.kubernetes.io/out-of-service 污点之前， 应该验证节点已经处于关闭或断电状态（而不是在重新启动中）。</p><p>将 Pod 移动到新节点后，用户需要手动移除停止服务的污点， 并且用户要检查关闭节点是否已恢复，因为该用户是最初添加污点的用户。</p><h3 id="参考-1">参考</h3><p><a href="https://www.cnblogs.com/ip99/p/14231203.html">kubernetes 提示 1 node(s) had taints that the pod didn’t tolerate</a></p><p><a href="https://kubernetes.io/zh-cn/docs/concepts/scheduling-eviction/taint-and-toleration/">污点</a></p><p><a href="https://www.densify.com/kubernetes-autoscaling/kubernetes-taints/">Kubernetes Taints &amp; Tolerations</a></p><h2 id="nodeselector">nodeSelector</h2><p>node 打label</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>kubectl label node1 <span class="nv">dedicated</span><span class="o">=</span><span class="nb">test</span>
<span class="c"># remove lable</span>
kubectl label node1 dedicated-
</pre></table></code></div></div><div class="language-yaml highlighter-rouge"><div class="code-header"> <span text-data=" YAML "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Pod</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">nginx</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">env</span><span class="pi">:</span> <span class="s">test</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">containers</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">nginx</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">registry.lesaunda.com.cn/busybox</span>
    <span class="na">command</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">sleep</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">3600"</span>
    <span class="na">imagePullPolicy</span><span class="pi">:</span> <span class="s">IfNotPresent</span>
  <span class="na">nodeSelector</span><span class="pi">:</span>
    <span class="na">dedicated</span><span class="pi">:</span> <span class="s">test</span>
</pre></table></code></div></div><h2 id="tools">Tools</h2><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>yum <span class="nt">-y</span> <span class="nb">install </span>net-tools
</pre></table></code></div></div><h2 id="pvc">PVC</h2><p>nfs 卷能将 NFS (网络文件系统) 挂载到你的 Pod 中。 不像 emptyDir 那样会在删除 Pod 的同时也会被删除，nfs 卷的内容在删除 Pod 时会被保存，卷只是被卸载。</p><p>若 pvc status = Terminating</p><p>打补丁</p><p><code class="language-plaintext highlighter-rouge">kubectl -n redis-cluster patch pvc data-redis-cluster-0 -p '{"metadata":{"finalizers":null}}'</code></p><h2 id="ingrees-nginx">ingrees-nginx</h2><h3 id="部署">部署</h3><p><code class="language-plaintext highlighter-rouge">kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.5.1/deploy/static/provider/cloud/deploy.yaml</code></p><p>利用pod sepc 反亲和性 确保每个node只有一个ingress-nginx</p><p>引用 <a href="https://github.com/kubernetes/ingress-nginx/issues/875">Question: nginx - multiple replicas or daemonSet?</a></p><blockquote><p>Using a deployment with an anti-affinity rule to avoid multiple replicas in the same node is, in most of the cases, more than enough.</p></blockquote><p>以及参考 <a href="https://kubernetes.io/zh-cn/docs/concepts/scheduling-eviction/assign-pod-node/#inter-pod-affinity-and-anti-affinity">将 Pod 指派给节点</a></p><div class="language-yaml highlighter-rouge"><div class="code-header"> <span text-data=" YAML "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="na">affinity</span><span class="pi">:</span>
  <span class="na">podAntiAffinity</span><span class="pi">:</span>
    <span class="na">preferredDuringSchedulingIgnoredDuringExecution</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">weight</span><span class="pi">:</span> <span class="m">100</span>
      <span class="na">podAffinityTerm</span><span class="pi">:</span>
        <span class="na">labelSelector</span><span class="pi">:</span>
          <span class="na">matchExpressions</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">key</span><span class="pi">:</span> <span class="s">app.kubernetes.io/name</span>
            <span class="na">operator</span><span class="pi">:</span> <span class="s">In</span>
            <span class="na">values</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s">ingress-nginx</span>
        <span class="na">topologyKey</span><span class="pi">:</span> <span class="s2">"</span><span class="s">kubernetes.io/hostname"</span>
</pre></table></code></div></div><h3 id="配置">配置</h3><p>group, 捕获第n个组</p><div class="language-yaml highlighter-rouge"><div class="code-header"> <span text-data=" YAML "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">networking.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Ingress</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">sysinfo-ingress</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">lesaunda</span>
  <span class="na">annotations</span><span class="pi">:</span>
    <span class="na">nginx.ingress.kubernetes.io/rewrite-target</span><span class="pi">:</span> <span class="s">/$2</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">ingressClassName</span><span class="pi">:</span> <span class="s">nginx</span>
  <span class="na">rules</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">http</span><span class="pi">:</span>
      <span class="na">paths</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">pathType</span><span class="pi">:</span> <span class="s">Prefix</span>
        <span class="na">path</span><span class="pi">:</span> <span class="s">/sysinfo/api(/|$)(.*)</span>
        <span class="na">backend</span><span class="pi">:</span>
          <span class="na">service</span><span class="pi">:</span>
            <span class="na">name</span><span class="pi">:</span> <span class="s">ls-sysinfo</span>
            <span class="na">port</span><span class="pi">:</span>
              <span class="na">number</span><span class="pi">:</span> <span class="m">3000</span>
</pre></table></code></div></div><p>正则匹配，保留 <code class="language-plaintext highlighter-rouge">/api/v1/staffs</code></p><div class="language-yaml highlighter-rouge"><div class="code-header"> <span text-data=" YAML "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="na">annotations</span><span class="pi">:</span>
  <span class="na">nginx.ingress.kubernetes.io/use-regex</span><span class="pi">:</span> <span class="s1">'</span><span class="s">true'</span>
<span class="na">spec</span><span class="pi">:</span>
 <span class="na">ingressClassName</span><span class="pi">:</span> <span class="s">nginx</span>
  <span class="s">rules</span><span class="err">:</span>
  <span class="pi">-</span> <span class="na">http</span><span class="pi">:</span>
      <span class="na">paths</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">path</span><span class="pi">:</span> <span class="s">/api/v\d+/(staffs|accounts)</span>
          <span class="na">pathType</span><span class="pi">:</span> <span class="s">Prefix</span>
          <span class="na">backend</span><span class="pi">:</span>
            <span class="na">service</span><span class="pi">:</span>
              <span class="na">name</span><span class="pi">:</span> <span class="s">lsd-staff-services</span>
              <span class="na">port</span><span class="pi">:</span>
                <span class="na">number</span><span class="pi">:</span> <span class="m">80</span>

</pre></table></code></div></div><h3 id="问题">问题</h3><ol><li><p>镜像问题</p><p>导出文件</p><p><code class="language-plaintext highlighter-rouge">curl -o ingress-nginx-deploy-backup.yaml https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.5.1/deploy/static/provider/cloud/deploy.yaml</code></p><p>register.k8s.io 无法访问，阿里云镜像代替，pull 之后修改 deployment.yaml</p><p><code class="language-plaintext highlighter-rouge">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-webhook-certgen:v20220916-gd32f8c343</code> <code class="language-plaintext highlighter-rouge">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/nginx-ingress-controller:v1.5.1</code></p><p>apply 即可</p><li><p>Internal error occurred: failed calling webhook “validate.nginx.ingress.kubernetes.io”</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nv">$ </span>kubectl delete <span class="nt">-A</span> ValidatingWebhookConfiguration ingress-nginx-admission
validatingwebhookconfiguration.admissionregistration.k8s.io <span class="s2">"ingress-nginx-admission"</span> deleted
</pre></table></code></div></div><p>参考<a href="https://pet2cattle.com/2021/02/service-ingress-nginx-controller-admission-not-found">Kubernetes: nginx ingress controller - failed calling webhook</a></p><p><a href="https://kubernetes.io/zh-cn/docs/tasks/access-application-cluster/ingress-minikube/">在 Minikube 环境中使用 NGINX Ingress 控制器配置 Ingress</a></p><li><p>tcp 转发</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="nv">$kubectl</span>  <span class="nt">-n</span> ingress-nginx get cm

tcp-services               1      191d

<span class="nv">$kubectl</span> <span class="nt">-n</span> ingrees-nginx edit cm tcp-services

data:
  <span class="s2">"5672"</span>: rabbitmq-system/lsd-rabbitmq:5672
</pre></table></code></div></div><li><p>413 request entity too large</p></ol><p>上传文件，nginx 转发，size 超过 limit</p><p>查看<code class="language-plaintext highlighter-rouge">kubectl exec -n ingress-nginx &lt;ingress pod&gt; cat nginx.conf|grep client_max_body_size</code></p><p><code class="language-plaintext highlighter-rouge">client_max_body_size 1m</code> default 1m</p><p>修改<code class="language-plaintext highlighter-rouge">kubectl -n ingress-nginx edit cm ingress-nginx-controller</code></p><div class="language-yaml highlighter-rouge"><div class="code-header"> <span text-data=" YAML "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>  <span class="na">data</span><span class="pi">:</span>
    <span class="na">proxy-body-size</span><span class="pi">:</span> <span class="s">10m</span>
</pre></table></code></div></div><p>相关配置可以参考 <a href="https://loft.sh/blog/kubernetes-nginx-ingress-10-useful-configuration-options">Kubernetes NGINX Ingress: 10 Useful Configuration Options</a></p><h2 id="redis-cluster">redis cluster</h2><p>参考<a href="https://www.cnblogs.com/LiuChang-blog/p/15898005.html">k8s 中部署 redis 集群(三主三从)</a></p><p>获取 pods ip 地址 <code class="language-plaintext highlighter-rouge">kubectl get pods -l app=redis-cluster -n redis-cluster -o jsonpath='{range.items[*]}{.status.podIP}:6379 '</code></p><p>redis-cli -a [password] –cluster create 10.244.2.89:6379 10.244.2.90:6379 10.244.0.20:6379 10.244.2.91:6379 10.244.0.21:6379 10.244.2.92:6379 –cluster-replicas 1</p><p>所有pods down, 要手动delete rdb file, aof file, nodes.conf ，redis-cli 执行 flushdb, cluster reset,比较复杂，采用下面方式重建</p><p>如果所有 pod 下线，需要重新建群</p><div class="language-sh highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="nv">$ </span>kubectl delete <span class="nt">-f</span> redis-cluster.yml <span class="c"># 删除资源</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="o">{</span>0..5<span class="o">}</span><span class="p">;</span> <span class="k">do </span>kubectl delete pvc/data-redis-cluster-<span class="nv">$1</span> <span class="nt">-n</span> redis-cluster<span class="p">;</span> <span class="k">done</span><span class="p">;</span> <span class="c"># 删除pvc</span>
<span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="o">{</span>0..5<span class="o">}</span><span class="p">;</span> <span class="k">do </span><span class="nb">rm</span> <span class="nt">-rf</span> /root/nfs_root/redis-cluster-data-redis-cluster-<span class="nv">$i</span><span class="p">;</span> <span class="k">done</span><span class="p">;</span> <span class="c"># 删除nfs</span>
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> redis-cluster.yml <span class="c"># 部署资源</span>
<span class="nv">$ </span>kubectl get pods <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>redis-cluster <span class="nt">-n</span> redis-cluster <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{range.items[*]}{.status.podIP}:6379 '</span> <span class="c"># 获取ip</span>
<span class="nv">$ </span>kubectl <span class="nt">-n</span> redis-cluster <span class="nb">exec</span> <span class="nt">-it</span> redis-cluster-0 /bin/sh <span class="c"># 进入pod</span>
<span class="nv">$ </span>redis-cli <span class="nt">-a</span> password <span class="nt">--cluster</span> create 10.244.2.89:6379 10.244.2.90:6379 10.244.0.20:6379 10.244.2.91:6379 10.244.0.21:6379 10.244.2.92:6379 <span class="nt">--cluster-replicas</span> 1 <span class="c"># build cluster</span>
</pre></table></code></div></div><p>或者(验证过，无法build cluster,要 delete rdb file, aof file, nodes.conf ，redis-cli 执行 flushdb, cluster reset)</p><ol><li><code class="language-plaintext highlighter-rouge">kubectl delete -f redis-cluster.yml</code> 删除资源<li><code class="language-plaintext highlighter-rouge">rm -f /ifs/kubernetes/redis-cluster-data-redis-cluster-0*/nodes.conf*</code> 逐一删除 nodes.conf<li><code class="language-plaintext highlighter-rouge">kubectl apply -f redis-cluster.yml</code> 重新建立集群</ol><p>for i in {0..5}; do rm -rf /root/nfs_root/redis-cluster-data-redis-cluster-$i; done;</p><p>for i in {0..5}; do kubectl delete pvc/data-redis-cluster-$1 -n redis-cluster; done;</p><h3 id="redisinsight">redisinsight</h3><p>参考<a href="https://docs.redis.com/latest/ri/installing/install-k8s/">Install RedisInsight on Kubernetes</a></p><p><a href="https://kubernetes.io/zh-cn/docs/concepts/services-networking/service/#loadbalancer">LoadBalancer</a></p><blockquote><p>要实现 type: LoadBalancer 的服务，Kubernetes 通常首先进行与请求 type: NodePort 服务等效的更改。 cloud-controller-manager 组件然后配置外部负载均衡器以将流量转发到已分配的节点端口。</p></blockquote><p>访问 http://172.21.14.208:30738/</p><h2 id="mysql-cluster">mysql cluster</h2><p><a href="https://dev.mysql.com/doc/mysql-operator/en/mysql-operator-installation-kubectl.html">Install using Manifest Files</a></p><blockquote><p>start failed in pod mysqlcluster-2_mysql(7059d32c-bfd3-4d75-9155-5cb1c1dcc2bc): ErrImagePull: rpc error: code = Unknown desc = failed to pull and unpack image “container-registry.oracle.com/mysql/community-operator:8.0.33-2.0.10”: failed to read expected number of bytes: unexpected EOF</p></blockquote><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>ctr <span class="nt">-n</span> k8s.io i pull container-registry.oracle.com/mysql/community-operator:8.0.33-2.0.10
<span class="c"># 部分layer 下载非常慢，在其他node push image，再pull,同样慢，layer 指定了url，去掉 -n k8s.io ，下载再加上即可</span>

<span class="c"># 删除 会stuck ，+ force</span>
kubectl <span class="nt">-n</span> mysql delete pod mysqlcluster-2 <span class="nt">--force</span>

systemctl restart kubelet
</pre></table></code></div></div><h3 id="修改时区">修改时区</h3><p><a href="https://dba.stackexchange.com/questions/20217/mysql-set-utc-time-as-default-timestamp">MySQL Set UTC time as default timestamp</a></p><div class="language-sql highlighter-rouge"><div class="code-header"> <span text-data=" Sql "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="k">SELECT</span> <span class="o">@@</span><span class="k">global</span><span class="p">.</span><span class="n">time_zone</span><span class="p">,</span> <span class="o">@@</span><span class="k">session</span><span class="p">.</span><span class="n">time_zone</span><span class="p">;</span>
<span class="k">SELECT</span> <span class="k">CURRENT_TIMESTAMP</span><span class="p">();</span>
<span class="k">SET</span> <span class="o">@@</span><span class="k">session</span><span class="p">.</span><span class="n">time_zone</span><span class="o">=</span><span class="s1">'+08:00'</span><span class="p">;</span>
</pre></table></code></div></div><p>集群-永久性生效</p><p><code class="language-plaintext highlighter-rouge">kubectl -n mysql edit cm mysqlcluster-initconf</code></p><div class="language-yaml highlighter-rouge"><div class="code-header"> <span text-data=" YAML "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="na">mycnf</span><span class="pi">:</span> <span class="pi">|</span>
  <span class="s">[mysqld]</span>
  <span class="s">max_connections=162</span>
  <span class="s">default_time_zone='+08:00'</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">kubectl -n mysql scale statefulSet mysqlcluster --replicas=0</code></p><p><code class="language-plaintext highlighter-rouge">kubectl -n mysql scale statefulSet mysqlcluster --replicas=3</code></p><h2 id="修改-control-plane-endpoint">修改 Control-Plane-Endpoint</h2><p>api service 做 HA 高可用</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>kubeadm init <span class="se">\</span>
<span class="nt">--kubernetes-version</span><span class="o">=</span>v1.25.3 <span class="se">\</span>
<span class="nt">--image-repository</span><span class="o">=</span>registry.aliyuncs.com/google_containers <span class="se">\</span>
<span class="nt">--pod-network-cidr</span><span class="o">=</span>10.244.0.0/16  <span class="se">\</span>
<span class="nt">--control-plane-endpoint</span><span class="o">=</span>&lt;LB address or commonname&gt; <span class="se">\</span>
<span class="nt">--cri-socket</span><span class="o">=</span>unix:///run/containerd/containerd.sock <span class="se">\</span>
<span class="nt">--v</span><span class="o">=</span>9
</pre></table></code></div></div><p>如果想从non-HA Convert to HA ,非常复杂，可以参考 <a href="https://blog.scottlowe.org/2019/08/12/converting-kubernetes-to-ha-control-plane/">Converting Kubernetes to an HA Control Plane</a></p><p>保留etcd ，reinit 的方法不可行，将丢失init的node，考虑将ip指向vm，再vm上做LB</p><h2 id="install-as-node">Install as node</h2><ol><li><code class="language-plaintext highlighter-rouge">mv /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.bak</code><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nv">$ </span>wget <span class="nt">-O</span> /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-7.repo
<span class="nv">$ </span>yum clean all
<span class="nv">$ </span>yum makecache
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">yum update</code></p><li>network，<a href="https://kubernetes.io/zh-cn/docs/setup/production-environment/container-runtimes">安装和配置先决条件</a><li>关闭防火墙 <code class="language-plaintext highlighter-rouge">systemctl disable firewall.service</code><li>setenforce 0 #关闭安全模式<div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="c"># ubuntu</span>
<span class="nb">sudo sed</span> <span class="nt">-i</span>.bak <span class="s1">'/ swap / s/^\(.*\)$/#\1/g'</span> /etc/fstab
<span class="nb">sudo </span>systemctl mask swap.target
</pre></table></code></div></div><li>swapoff -a #关闭内存交换,同时修改 /etc/fstab 注释 swap 行<li>配置docker.repo <code class="language-plaintext highlighter-rouge">yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</code><li>install containerd(preinstall runc and cni plugin), runc centos 7 自带（runc –version 1.1.7）， cni plugin flannel 由 kubelet 调度部署, enable 以及start<li>配置 <code class="language-plaintext highlighter-rouge">/etc/yum.repos.d/kubernetes.repo</code><pre><code class="language-ymal"> [kubernetes]
 name=Kubernetes
 baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/
 enabled=1
 gpgcheck=1
 repo_gpgcheck=1
 gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
</code></pre><li><code class="language-plaintext highlighter-rouge">yum install kubelet-1.25.3 kubeadm-1.25.3 kubectl-1.25.3 --nogpgcheck -y</code><li>修改 <code class="language-plaintext highlighter-rouge">/etc/containerd/config.toml</code> 注释<code class="language-plaintext highlighter-rouge">disabled_plugins = [“cri”]</code>以及添加registry.k8s.io,docker以及自建镜像库<li>install <a href="https://github.com/kubernetes-sigs/cri-tools">cri-tools</a>, 修改<code class="language-plaintext highlighter-rouge">vim /etc/crictl.yaml</code>, pull pasue3.6 以及tag<li>kubeadm join …..</ol><h2 id="container-runtime">container-runtime</h2><blockquote><p>Flag –container-runtime has been deprecated, will be removed in 1.27 as the only valid value is ‘remote’ <code class="language-plaintext highlighter-rouge">vim /var/lib/kubelet/kubeadm-flags.env</code> 移除 <code class="language-plaintext highlighter-rouge">--container-runtime</code>参数</p></blockquote><h2 id="helm">Helm</h2><p>Helm 是 Kubernetes 的包管理器</p><p>install</p><div class="language-sh highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nv">$ </span>curl <span class="nt">-fsSL</span> <span class="nt">-o</span> get_helm.sh https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3
<span class="nv">$ </span><span class="nb">chmod </span>700 get_helm.sh
<span class="nv">$ </span>./get_helm.sh
</pre></table></code></div></div><p><a href="https://helm.sh/zh/docs/intro/install/">安装Helm</a></p><div class="language-sh highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>helm add repo <span class="o">[</span>name] <span class="o">[</span>url]

helm search repo <span class="o">[</span>name]
</pre></table></code></div></div><h2 id="参考-2">参考</h2><p><a href="https://blog.51cto.com/liqingbiao/5149544">通过 kubeadm 安装不同版本的 K8S</a></p><p><a href="https://www.cnblogs.com/gaoyuechen/p/16851566.html">kubeadm 极速部署 Kubernetes 1.25 版本集群</a></p><p><a href="https://www.cnblogs.com/root0/p/16838234.html">使用 kubeadm 搭建 k8s 1.25.3 版本</a></p><p><a href="https://www.cnblogs.com/kevingrace/p/14412134.html">K8S 部署 Redis Cluster 集群（三主三从模式） - 部署笔记</a></p><p><a href="https://discuss.kubernetes.io/">Community Forums,问答论坛</a></p><p><a href="https://sematext.com/blog/tail-kubernetes-logs">How to Tail Kubernetes Logs: Using the Kubectl Command to See Pod, Container, and Deployment Logs</a></p><p><a href="https://kubernetes.io/zh-cn/docs/reference/kubectl/">kubectl 命令参考</a></p><p><a href="https://kubernetes.io/zh-cn/docs/reference/setup-tools/kubeadm/kubeadm-init-phase/">kubeadm init phase</a></p><p><a href="https://kubernetes.io/zh-cn/docs/concepts/workloads/pods/downward-api/">Downward API</a></p><p><a href="https://jimmysong.io/kubernetes-handbook/concepts/flannel.html">扁平网络 Flannel</a></p><p><a href="https://github.com/StackExchange/StackExchange.Redis/issues/1188">Multiple databases are not supported on this server; cannot switch to database</a></p><p><a href="https://kubernetes.io/zh-cn/docs/setup/production-environment/container-runtimes/#%E8%BD%AC%E5%8F%91-ipv4-%E5%B9%B6%E8%AE%A9-iptables-%E7%9C%8B%E5%88%B0%E6%A1%A5%E6%8E%A5%E6%B5%81%E9%87%8F">net.ipv4.ip_forward=1</a></p><p><a href="https://kubernetes.io/zh-cn/docs/tasks/administer-cluster/dns-debugging-resolution/">调试 DNS 问题</a></p><p><a href="http://www.mydlq.club/article/78/">解决 Kubernetes 中 Pod 无法正常域名解析问题分析与 IPVS parseIP Error 问题</a></p><p><a href="https://coredns.io/plugins/forward/">coredns 官网</a></p><p><a href="https://wiki.archlinux.org/title/Network_bridge">Network bridge</a></p><p><a href="https://kubernetes.github.io/ingress-nginx/deploy/#quick-start">Installation Guide</a></p><p><a href="https://blog.csdn.net/yucaifu1989/article/details/104683659">防火墙规则</a></p><p><a href="https://segmentfault.com/a/1190000038582391">ingress-nginx tcp/udp 转发</a>，</p><p><a href="https://cloud.tencent.com/developer/article/1761376">真一文搞定 ingress-nginx 的使用</a></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/kubernetes/'>kubernetes</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/kubernetes/" class="post-tag no-text-decoration" >kubernetes</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> 本文由作者按照 <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> 进行授权</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">分享</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=kubernetes install - zengxiangqiu&url=https://zengxiangqiu.github.io/posts/kubernetes-install/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=kubernetes install - zengxiangqiu&u=https://zengxiangqiu.github.io/posts/kubernetes-install/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=kubernetes install - zengxiangqiu&url=https://zengxiangqiu.github.io/posts/kubernetes-install/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="分享链接" title-succeed="链接已复制！"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>最近更新</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/Docker/">Docker</a><li><a href="/posts/window-commands/">window commands</a><li><a href="/posts/kubernetes-install/">kubernetes install</a><li><a href="/posts/MySQL/"> MySQL</a><li><a href="/posts/kubernetes-mysql/">kubernetes mysql</a></ul></div><div id="access-tags"> <span>热门标签</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/%E5%B7%A5%E5%85%B7/">工具</a> <a class="post-tag" href="/tags/k8s/">k8s</a> <a class="post-tag" href="/tags/redis/">redis</a> <a class="post-tag" href="/tags/%E6%B5%8B%E8%AF%95/">测试</a> <a class="post-tag" href="/tags/database/">database</a> <a class="post-tag" href="/tags/deployment/">Deployment</a> <a class="post-tag" href="/tags/ef/">ef</a> <a class="post-tag" href="/tags/httpclient/">httpclient</a> <a class="post-tag" href="/tags/js/">js</a> <a class="post-tag" href="/tags/linq/">linq</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">文章内容</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>相关文章</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/kubernetes-mysql/"><div class="card-body"> <span class="timeago small" >03-13<i class="unloaded">2024-03-13T16:33:32+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>kubernetes mysql</h3><div class="text-muted small"><p> 配置 1 2 3 4 [mysqld] default-time-zone = "+08:00" max_connections = 500 1 2 3 SELECT @@global.time_zone; show variables like "max_connections"; set global max_connections = 200; 1 2 3 4 5 6 7 ...</p></div></div></a></div><div class="card"> <a href="/posts/kubernetes-volume/"><div class="card-body"> <span class="timeago small" >2023-05-17<i class="unloaded">2023-05-17T10:28:14+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>kubernetes volume</h3><div class="text-muted small"><p> emptyDir emptyDir 用于节点临时存储，pod消失，volume内容消失 pv持久卷 分静态制备和动态制备 静态制备 pv 创建，status available pending, 等待绑定，pvc创建绑定，已申领未绑定， pod 创建，persistentVolumeClaim 中 绑定对应的pvc进行访问 创建-申领-绑定 动态制备 创建StorageCl...</p></div></div></a></div><div class="card"> <a href="/posts/Kubernetes-Role/"><div class="card-body"> <span class="timeago small" >2023-06-06<i class="unloaded">2023-06-06T09:55:36+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Kubernetes Role</h3><div class="text-muted small"><p> role对单一namespace资源授权 ClusterRole 除Role之外扩展node，endpoint,其他namespace rolebinding subjects(user, serviceaccount, group) roleRef(role,ClusterRole)</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/GrayLog/" class="btn btn-outline-primary" prompt="上一篇"><p>GrayLog</p></a> <a href="/posts/ElasticSearch/" class="btn btn-outline-primary" prompt="下一篇"><p> ElasticSearch</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://twitter.com/username">zengxiangqiu</a>. <span data-toggle="tooltip" data-placement="top" title="除非另有说明，本网站上的博客文章均由作者按照知识共享署名 4.0 国际 (CC BY 4.0) 许可协议进行授权。">保留部分权利。</span></p></div><div class="footer-right"><p class="mb-0"> 本站由 <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> 生成，采用 <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> 主题。</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">热门标签</h4><a class="post-tag" href="/tags/%E5%B7%A5%E5%85%B7/">工具</a> <a class="post-tag" href="/tags/k8s/">k8s</a> <a class="post-tag" href="/tags/redis/">redis</a> <a class="post-tag" href="/tags/%E6%B5%8B%E8%AF%95/">测试</a> <a class="post-tag" href="/tags/database/">database</a> <a class="post-tag" href="/tags/deployment/">Deployment</a> <a class="post-tag" href="/tags/ef/">ef</a> <a class="post-tag" href="/tags/httpclient/">httpclient</a> <a class="post-tag" href="/tags/js/">js</a> <a class="post-tag" href="/tags/linq/">linq</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">搜索结果为空</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script>
