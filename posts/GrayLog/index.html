<!DOCTYPE html><html lang="zh-CN" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="天前"><meta name="hour-prompt" content="小时前"><meta name="minute-prompt" content="分钟前"><meta name="justnow-prompt" content="刚刚"><meta name="generator" content="Jekyll v4.3.4" /><meta property="og:title" content="GrayLog" /><meta property="og:locale" content="zh_CN" /><meta name="description" content="注意" /><meta property="og:description" content="注意" /><link rel="canonical" href="https://zengxiangqiu.github.io/posts/GrayLog/" /><meta property="og:url" content="https://zengxiangqiu.github.io/posts/GrayLog/" /><meta property="og:site_name" content="zengxiangqiu" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-10-10T09:59:46+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="GrayLog" /><meta name="twitter:site" content="@zengxiangqiu" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2024-08-26T11:18:53+08:00","datePublished":"2022-10-10T09:59:46+08:00","description":"注意","headline":"GrayLog","mainEntityOfPage":{"@type":"WebPage","@id":"https://zengxiangqiu.github.io/posts/GrayLog/"},"url":"https://zengxiangqiu.github.io/posts/GrayLog/"}</script><title>GrayLog | zengxiangqiu</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="zengxiangqiu"><meta name="application-name" content="zengxiangqiu"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="zh-CN"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> </a></div><div class="site-title mt-3"> <a href="/">zengxiangqiu</a></div><div class="site-subtitle font-italic">知识库</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>首页</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>分类</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>标签</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>归档</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>关于</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/zengxiangqiu" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/zengxiangqiu" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['example','doamin.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> 首页 </a> </span> <span>GrayLog</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> 文章</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="搜索..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >取消</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>GrayLog</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> zengxiangqiu </span> 发表于 <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="2022-10-10, 09:59 +0800" >2022-10-10<i class="unloaded">2022-10-10T09:59:46+08:00</i> </span></div><div> <span> 更新于 <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="2024-08-26, 11:18 +0800" >08-26<i class="unloaded">2024-08-26T11:18:53+08:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="973 字">5 分钟 阅读</span></div></div><div class="post-content"><p>注意</p><p><strong>Graylog 3.x does not work with Elasticsearch 7.x!</strong></p><p>Graylog Sidercar 自带 filebeat, winlogbeat,window install</p><p>window install</p><p><a href="https://github.com/Graylog2/collector-sidecar/releases">下载</a>，选择 1.0.2的版本，因为 3.x graylog sidecar max version 1.0.X</p><ol><li><p>静默方式运行 <code class="language-plaintext highlighter-rouge">graylog_sidecar_installer_1.0.2-1.exe /S -SERVERURL=http://192.168.20.95:9000 -APITOKEN=1s9dtljlbh37j61fo8psuneuq8sntshe7ibco8vhs649c9cf9o2j</code></p><li><p>双击exe打开安装界面填入信息</p></ol><p>查看或修改 <code class="language-plaintext highlighter-rouge">C:\Program Files\Graylog\sidecar\sidecar.yml</code></p><p>以服务方式运行</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>&amp; <span class="s2">"C:</span><span class="se">\P</span><span class="s2">rogram Files</span><span class="se">\g</span><span class="s2">raylog</span><span class="se">\s</span><span class="s2">idecar</span><span class="se">\g</span><span class="s2">raylog-sidecar.exe"</span> <span class="nt">-service</span> <span class="nb">install</span>
&amp; <span class="s2">"C:</span><span class="se">\P</span><span class="s2">rogram Files</span><span class="se">\g</span><span class="s2">raylog</span><span class="se">\s</span><span class="s2">idecar</span><span class="se">\g</span><span class="s2">raylog-sidecar.exe"</span> <span class="nt">-service</span> start
</pre></table></code></div></div><p>打开 service.msc ,会存在两个Graylog—xxx 的服务，一个sidecar ，一个 collector，即 winlogbeat.</p><p>注册表</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>Computer<span class="se">\H</span>KEY_LOCAL_MACHINE<span class="se">\S</span>YSTEM<span class="se">\C</span>urrentControlSet<span class="se">\S</span>ervices<span class="se">\g</span>raylog-sidecar
Computer<span class="se">\H</span>KEY_LOCAL_MACHINE<span class="se">\S</span>YSTEM<span class="se">\C</span>urrentControlSet<span class="se">\S</span>ervices<span class="se">\g</span>raylog-collector-winlogbeat
</pre></table></code></div></div><p>当前 graylog es 版本 <code class="language-plaintext highlighter-rouge">"Elasticsearch" : "6.7.2"</code></p><h2 id="kopf">Kopf</h2><p>kopf 仅适用于 es2.x 版本</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>docker run <span class="nt">-d</span> <span class="nt">-p</span> 80:80 <span class="nt">-e</span> <span class="nv">KOPF_SERVER_NAME</span><span class="o">=</span>grafana.dev <span class="nt">-e</span> <span class="nv">KOPF_ES_SERVERS</span><span class="o">=</span>192.168.20.xx:9200 <span class="nt">--name</span> kopf lmenezes/elasticsearch-kopf

docker run <span class="nt">--name</span><span class="o">=</span>kopf <span class="nt">--env</span><span class="o">=</span><span class="nv">KOPF_SERVER_NAME</span><span class="o">=</span>grafana.dev <span class="nt">--env</span><span class="o">=</span><span class="nv">KOPF_ES_SERVERS</span><span class="o">=</span>192.168.20.95:9200 <span class="nt">--expose</span><span class="o">=</span>443 <span class="nt">-p</span> 8080:80 <span class="nt">--restart</span><span class="o">=</span>always  lmenezes/elasticsearch-kopf
</pre></table></code></div></div><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre>docker run <span class="nt">-d</span> <span class="nt">-p</span> 9200:9200 <span class="nt">-p</span> 9300:9300 <span class="se">\</span>
 <span class="nt">-v</span> /var/lib/elasticsearch:/var/lib/elasticsearch <span class="se">\</span>
 <span class="nt">-v</span> /var/log/elasticsearch:/var/log/elasticsearch <span class="se">\</span>
 <span class="nt">--cap-add</span><span class="o">=</span>IPC_LOCK <span class="nt">--ulimit</span> <span class="nv">nofile</span><span class="o">=</span>65536:65536 <span class="nt">--ulimit</span> <span class="nv">memlock</span><span class="o">=</span><span class="nt">-1</span>:-1 <span class="se">\</span>
 <span class="nt">-e</span> cluster.name<span class="o">=</span>graylog <span class="se">\</span>
 <span class="nt">-e</span> node.name<span class="o">=</span>es-01 <span class="se">\</span>
 <span class="nt">-e</span> bootstrap.memory_lock<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
 <span class="nt">-e</span> <span class="nv">ES_JAVA_OPTS</span><span class="o">=</span><span class="s2">"-Xms512m -Xmx512m"</span> <span class="se">\</span>
 <span class="nt">-e</span> node.master<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
 <span class="nt">-e</span> network.bind_host<span class="o">=</span>0.0.0.0 <span class="se">\</span>
 <span class="nt">-e</span> network.host<span class="o">=</span>0.0.0.0 <span class="se">\</span>
 <span class="nt">-e</span> network.publish_host<span class="o">=</span>192.168.1.211 <span class="se">\</span>
 <span class="nt">-e</span> node.data<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
 <span class="nt">-e</span> discovery.zen.ping_timeout<span class="o">=</span>120s <span class="se">\</span>
 <span class="nt">-e</span> discovery.zen.minimum_master_nodes<span class="o">=</span>2 <span class="se">\</span>
 <span class="nt">-e</span> client.transport.ping_timeout<span class="o">=</span>60s <span class="se">\</span>
 <span class="nt">-e</span> discovery.zen.ping.unicast.hosts<span class="o">=</span><span class="s2">"192.168.20.95"</span> <span class="se">\</span>
 <span class="nt">-e</span> path.data<span class="o">=</span>/var/lib/elasticsearch <span class="se">\</span>
 <span class="nt">-e</span> path.logs<span class="o">=</span>/var/log/elasticsearch <span class="se">\</span>
 docker.elastic.co/elasticsearch/elasticsearch:6.7.2
</pre></table></code></div></div><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre>docker run <span class="nt">-d</span> <span class="nt">-p</span> 9200:9200 <span class="nt">-p</span> 9300:9300 <span class="se">\</span>
 <span class="nt">-e</span> bootstrap.memory_lock<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
 <span class="nt">-e</span> <span class="nv">ES_JAVA_OPTS</span><span class="o">=</span><span class="s2">"-Xms512m -Xmx512m"</span> <span class="se">\</span>
 <span class="nt">-v</span> /var/lib/elasticsearch:/var/lib/elasticsearch <span class="se">\</span>
 <span class="nt">-v</span> /var/log/elasticsearch:/var/log/elasticsearch <span class="se">\</span>
 <span class="nt">-v</span> /root/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml <span class="se">\</span>
 <span class="nt">--cap-add</span><span class="o">=</span>IPC_LOCK <span class="nt">--ulimit</span> <span class="nv">nofile</span><span class="o">=</span>65536:65536 <span class="nt">--ulimit</span> <span class="nv">memlock</span><span class="o">=</span><span class="nt">-1</span>:-1 <span class="se">\</span>
 docker.elastic.co/elasticsearch/elasticsearch:6.7.2
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">sysctl -w vm.max_map_count=262144</code></p><h2 id="graylog-查询语法">graylog 查询语法</h2><p>Messages where the field type includes ssh :</p><p><code class="language-plaintext highlighter-rouge">type:ssh </code></p><p>查看 JDK 版本 <code class="language-plaintext highlighter-rouge">javac -version</code></p><p>SiderCar 日志收集器的轻量级配置管理组件</p><div class="language-yaml highlighter-rouge"><div class="code-header"> <span text-data=" YAML "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">elasticsearch.k8s.elastic.co/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Elasticsearch</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">quickstart</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">version</span><span class="pi">:</span> <span class="s">8.4.3</span>
  <span class="na">nodeSets</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">default</span>
      <span class="na">count</span><span class="pi">:</span> <span class="m">1</span>
      <span class="na">config</span><span class="pi">:</span>
        <span class="na">node.store.allow_mmap</span><span class="pi">:</span> <span class="kc">false</span>
</pre></table></code></div></div><h2 id="sidercar">SiderCar</h2><p>sidecar 通过 url 发现 graylog server，并告知 server，机上有哪些日志收集器，如 filebeat， graylog server 推送 congfiguration 到收集器</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre>wget https://github.com/Graylog2/collector-sidecar/releases/download/1.0.2/graylog-sidecar_1.0.2-1_amd64.deb
<span class="nb">sudo </span>dpkg <span class="nt">-i</span> graylog-sidecar_1.0.2-1_amd64.deb
<span class="nb">sudo </span>apt-get update <span class="o">&amp;&amp;</span> <span class="nb">sudo </span>apt-get <span class="nb">install </span>graylog-sidecar

vi /etc/graylog/sidecar/sidecar.yml

<span class="nb">sudo </span>graylog-sidecar <span class="nt">-service</span> <span class="nb">install</span>

<span class="c"># Ubuntu 14.04 with Upstart</span>
<span class="nb">sudo </span>start graylog-sidecar

<span class="c"># Ubuntu 16.04 and later with systemd</span>
<span class="nb">sudo </span>systemctl <span class="nb">enable </span>graylog-sidecar
<span class="nb">sudo </span>systemctl start graylog-sidecar
</pre></table></code></div></div><p>修改 server_url,server_api_token</p><p>获取 server_api_token</p><p>http://192.168.xx.xx:9000/system/authentication/users/tokens/graylog-sidecar</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>vim /etc/graylog/sidecar/sidecar.yml
</pre></table></code></div></div><p>填入</p><div class="language-yml highlighter-rouge"><div class="code-header"> <span text-data=" YAML "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="na">server_url</span><span class="pi">:</span> <span class="s2">"</span><span class="s">http://192.168.xx.95:9000/api/"</span>

<span class="c1"># The API token to use to authenticate against the Graylog server API.</span>
<span class="c1"># This field is mandatory</span>
<span class="na">server_api_token</span><span class="pi">:</span> <span class="s2">"</span><span class="s">xxxxx"</span>
<span class="s">....</span>
</pre></table></code></div></div><h2 id="syslog">Syslog</h2><p>The syslog input reads Syslog events as specified by RFC 3164 and RFC 5424, over TCP, UDP, or a Unix stream socket.</p><h2 id="filebeat">Filebeat</h2><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>curl <span class="nt">-L</span> <span class="nt">-O</span> https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-8.5.2-amd64.deb
<span class="nb">sudo </span>dpkg <span class="nt">-i</span> filebeat-8.5.2-amd64.deb

<span class="nb">sudo </span>service filebeat start
</pre></table></code></div></div><p>创建 Collector Configuration</p><div class="language-yaml highlighter-rouge"><div class="code-header"> <span text-data=" YAML "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre><span class="c1"># Needed for Graylog</span>
<span class="na">fields_under_root</span><span class="pi">:</span> <span class="kc">true</span>
<span class="na">fields.collector_node_id</span><span class="pi">:</span> <span class="s">${sidecar.nodeName}</span>
<span class="na">fields.gl2_source_collector</span><span class="pi">:</span> <span class="s">${sidecar.nodeId}</span>
<span class="na">fields.source</span><span class="pi">:</span> <span class="s">${sidecar.nodeName}</span>

<span class="na">filebeat.inputs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">input_type</span><span class="pi">:</span> <span class="s">log</span>
    <span class="na">paths</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">/var/log/nginx/*.log</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">log</span>
    <span class="na">fields</span><span class="pi">:</span>
      <span class="na">source</span><span class="pi">:</span> <span class="s">nginx</span>
    <span class="na">tags</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">staffApi</span>
<span class="na">output.logstash</span><span class="pi">:</span>
  <span class="na">hosts</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">192.168.xx.95:5044"</span><span class="pi">]</span>
<span class="na">path</span><span class="pi">:</span>
  <span class="na">data</span><span class="pi">:</span> <span class="s">/var/lib/graylog-sidecar/collectors/filebeat/data</span>
  <span class="na">logs</span><span class="pi">:</span> <span class="s">/var/lib/graylog-sidecar/collectors/filebeat/log</span>
</pre></table></code></div></div><div class="language-sh highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre>
<span class="c"># see a list of enabled and disabled modules</span>
filebeat modules list

<span class="c"># systemctl status filebeat.service is inactive</span>

<span class="c"># 查看, shift+f , up or down to select column and enter s to sort and enter q</span>
top

<span class="c"># 查看 command</span>
ps <span class="nt">-Flww</span> <span class="nt">-p</span>  &lt;pid&gt;

4 S root        1133     778  0  80   0 - 356179 -     81972   0 Feb20 ?        00:55:29 /usr/share/filebeat/bin/filebeat <span class="nt">-c</span> /var/lib/graylog-sidecar/generated/filebeat.conf

<span class="c"># 查看 -c 文件</span>

</pre></table></code></div></div><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>docker run  <span class="nt">-p</span> 9000:9000 <span class="nt">-p</span> 12201:12201 <span class="nt">-p</span> 1514:1514   <span class="nt">-v</span> ~/graylog_config:/usr/share/graylog/data/config  <span class="nt">-v</span> ~/graylog_journal:/var/lib/graylog-server/journal   graylog/graylog:3.1.3
</pre></table></code></div></div><p>kubernetes 部署<a href="https://raw.githubusercontent.com/elastic/beats/7.17/deploy/kubernetes/filebeat-kubernetes.yaml">filebeat</a>, 发现 es 6.x 只支持 beat 6.X 的版本，但 type container 要 7.x 才支持，所以不能output.elasticsearch ，改为output.logstash 指向 graylog 5044端口进行数据清洗。</p><p>hits 模块，根据pod annotations 和label 自定义配置要收集的pod conf</p><p>The hints system looks for hints in Kubernetes Pod annotations or Docker labels that have the prefix co.elastic.logs. As soon as the container starts, Filebeat will check if it contains any hints and launch the proper config for it.</p><h2 id="docker">Docker</h2><div class="language-sh highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>docker run   <span class="nt">-p</span> 9000:9000 <span class="nt">-p</span> 12201:12201 <span class="nt">-p</span> 1514:1514   <span class="nt">-v</span> ~/graylog_config:/usr/share/graylog/data/config  <span class="nt">-v</span> ~/graylog_journal:/var/lib/graylog-server/journal <span class="nt">-d</span>   graylog/graylog:3.1.3
</pre></table></code></div></div><div class="language-sh highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre> docker run    <span class="se">\</span>
    <span class="nt">-p</span> 9000:9000 <span class="nt">-p</span> 12201:12201 <span class="nt">-p</span> 1514:1514 <span class="nt">-p</span> 5555:5555 <span class="se">\</span>
    <span class="nt">-e</span> <span class="nv">GRAYLOG_ELASTICSEARCH_HOSTS</span><span class="o">=</span><span class="s2">"http://192.168.20.95:9200"</span> <span class="se">\</span>
    <span class="nt">-e</span> <span class="nv">GRAYLOG_IS_MASTER</span><span class="o">=</span><span class="s2">"false"</span> <span class="se">\</span>
    <span class="nt">-e</span> <span class="nv">GRAYLOG_MONGODB_URI</span><span class="o">=</span><span class="s2">"mongodb://192.168.20.95/graylog"</span> <span class="se">\</span>
    <span class="nt">-e</span> <span class="nv">GRAYLOG_STALE_MASTER_TIMEOUT</span><span class="o">=</span>30000 <span class="se">\</span>
    <span class="nt">-d</span> graylog/graylog:3.2
</pre></table></code></div></div><div class="language-ini highlighter-rouge"><div class="code-header"> <span text-data=" Ini "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="py">is_master</span> <span class="p">=</span> <span class="s">false</span>
<span class="py">mongodb_uri</span> <span class="p">=</span> <span class="s">mongodb://192.168.xx./graylog</span>
<span class="py">stale_master_timeout</span> <span class="p">=</span> <span class="s">30000</span>
<span class="py">elasticsearch_hosts</span> <span class="p">=</span> <span class="s">http://192.168.xx.xx:9200</span>
<span class="py">http_external_uri</span> <span class="p">=</span> <span class="s">http://192.168.1.xxx:9000/</span>
<span class="py">http_bind_address</span> <span class="p">=</span> <span class="s">0.0.0.0:9000</span>
<span class="py">output_batch_size</span> <span class="p">=</span> <span class="s">5000</span>
</pre></table></code></div></div><h2 id="restapi">RestApi</h2><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>curl <span class="nt">-X</span> GET http://192.168.1.211:9000/api/system/sessions

curl <span class="nt">-X</span> GET http://127.0.0.1:9000/api/cluster
</pre></table></code></div></div><h2 id="提取器">提取器</h2><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span text-data=" Plaintext "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>destination -&gt;.*-&gt;([0-9]{1,3}.[0-9]{1,3}.[0-9]{1,3}.[0-9]{1,3})
visitor session created ([0-9]{1,3}.[0-9]{1,3}.[0-9]{1,3}.[0-9]{1,3})
</pre></table></code></div></div><h2 id="参考">参考</h2><p><a href="https://computingforgeeks.com/how-to-run-graylog-server-in-docker-containers/">docker install graylog</a></p><p><a href="https://www.elastic.co/guide/en/cloud/current/ec-add-user-settings.html">修改 es 配置文件</a></p><p><a href="https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-installation-configuration.html">Filebeat quick start: installation and configuration</a></p><p><a href="https://docs.graylog.org/docs/query-language#">grayLog 查询语法</a></p><p><a href="https://archivedocs.graylog.org/en/3.1/pages/architecture.html">grayLog v3.1 官方文档</a></p><p><a href="https://archivedocs.graylog.org/en/3.1/pages/configuration/file_location.html#default-file-location">grayLog 配置文件位置</a></p><p><a href="https://www.elastic.co/cn/support/matrix">支持一览表</a></p><p><a href="https://www.jianshu.com/p/c3709d3384a8">filebeat采集容器日志时根据kubernetes元数据限定采集源的问题</a></p><p><a href="https://www.tinymediamanager.org/docs/jmte#separators">Java Minimal Template Engine</a></p><p><a href="https://archivedocs.graylog.org/en/3.1/pages/streams/alerts.html?highlight=template#email-alert-notification">GrayLog 自定义邮件内容</a></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/system/'>system</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/graylog/" class="post-tag no-text-decoration" >grayLog</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> 本文由作者按照 <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> 进行授权</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">分享</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=GrayLog - zengxiangqiu&url=https://zengxiangqiu.github.io/posts/GrayLog/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=GrayLog - zengxiangqiu&u=https://zengxiangqiu.github.io/posts/GrayLog/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=GrayLog - zengxiangqiu&url=https://zengxiangqiu.github.io/posts/GrayLog/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="分享链接" title-succeed="链接已复制！"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>最近更新</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/Docker/">Docker</a><li><a href="/posts/window-commands/">window commands</a><li><a href="/posts/kubernetes-install/">kubernetes install</a><li><a href="/posts/MySQL/"> MySQL</a><li><a href="/posts/kubernetes-mysql/">kubernetes mysql</a></ul></div><div id="access-tags"> <span>热门标签</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/%E5%B7%A5%E5%85%B7/">工具</a> <a class="post-tag" href="/tags/k8s/">k8s</a> <a class="post-tag" href="/tags/redis/">redis</a> <a class="post-tag" href="/tags/%E6%B5%8B%E8%AF%95/">测试</a> <a class="post-tag" href="/tags/database/">database</a> <a class="post-tag" href="/tags/deployment/">Deployment</a> <a class="post-tag" href="/tags/ef/">ef</a> <a class="post-tag" href="/tags/httpclient/">httpclient</a> <a class="post-tag" href="/tags/js/">js</a> <a class="post-tag" href="/tags/linq/">linq</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">文章内容</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>相关文章</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/linux/"><div class="card-body"> <span class="timeago small" >2023-03-01<i class="unloaded">2023-03-01T11:22:33+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>linux</h3><div class="text-muted small"><p> 分区扩容 umount 时可能出现正在使用，执行以下命令 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 # 备份 xfsdump -f /home.xfsdump /home # 卸载 umount /home # 减容 lvreduce -L 50G /dev/mapper/centos-home # 扩容...</p></div></div></a></div><div class="card"> <a href="/posts/CentOS/"><div class="card-body"> <span class="timeago small" >2023-03-27<i class="unloaded">2023-03-27T14:20:53+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>CentOS</h3><div class="text-muted small"><p> ntp client 同步时间 1 2 3 4 5 6 7 vim /etc/chrony.conf # 修改 pool [ntp server ip] iburst systemctl restart chronyd 防火墙 1 2 3 4 5 6 service firewalld stop systemctl enable firewalld firewall-cmd ...</p></div></div></a></div><div class="card"> <a href="/posts/seatunnel/"><div class="card-body"> <span class="timeago small" >08-06<i class="unloaded">2024-08-06T09:54:30+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>seatunnel</h3><div class="text-muted small"><p> seatunnel seatunnel seatunnel-doc source exactly-once 如果数据源中的每条数据仅由源向下游发送一次，我们认为该source connector支持精确一次（exactly-once）。 sink exactly-once 当任意一条数据流入分布式系统时，如果系统在整个处理过程中仅准确处理任意一条数据一次，且处理结果正...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/%E7%AE%97%E6%B3%95/" class="btn btn-outline-primary" prompt="上一篇"><p> 算法</p></a> <a href="/posts/kubernetes-install/" class="btn btn-outline-primary" prompt="下一篇"><p>kubernetes install</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://twitter.com/username">zengxiangqiu</a>. <span data-toggle="tooltip" data-placement="top" title="除非另有说明，本网站上的博客文章均由作者按照知识共享署名 4.0 国际 (CC BY 4.0) 许可协议进行授权。">保留部分权利。</span></p></div><div class="footer-right"><p class="mb-0"> 本站由 <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> 生成，采用 <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> 主题。</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">热门标签</h4><a class="post-tag" href="/tags/%E5%B7%A5%E5%85%B7/">工具</a> <a class="post-tag" href="/tags/k8s/">k8s</a> <a class="post-tag" href="/tags/redis/">redis</a> <a class="post-tag" href="/tags/%E6%B5%8B%E8%AF%95/">测试</a> <a class="post-tag" href="/tags/database/">database</a> <a class="post-tag" href="/tags/deployment/">Deployment</a> <a class="post-tag" href="/tags/ef/">ef</a> <a class="post-tag" href="/tags/httpclient/">httpclient</a> <a class="post-tag" href="/tags/js/">js</a> <a class="post-tag" href="/tags/linq/">linq</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">搜索结果为空</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script>
