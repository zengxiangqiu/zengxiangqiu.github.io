---
title: "minikube"
date:  2022-05-23 14:23:37 +0800
categories: [DevOps]
tags: [kubernetes]
---




[How to Install Minikube on Ubuntu 18.04 / 20.04](https://phoenixnap.com/kb/install-minikube-on-ubuntu)


`minikube start` 出现 permission denied

`sudo groupadd docker`

` sudo usermod -aG docker $USER`

查看 `groups`


更新 ` newgrp docker`


`minikube start --image-repository registry.aliyuncs.com/google_containers  --image-mirror-country='cn' --vm-driver=none  --registry-mirror=https://registry.docker-cn.com --extra-config=kubelet.cgroup-driver=systemd --alsologtostderr --v=5`


`minikube start --image-repository registry.aliyuncs.com/google_containers --image-mirror-country='cn' --base-image="anjone/kicbase" --registry-mirror=https://registry.docker-cn.com  --alsologtostderr --v=8`





## 内网访问面板
`kubectl proxy --port=33493 --address=‘172.21.14.206’ --accept-hosts=’^.*’ &`


kubelet 会在集群中每个节点（node）上运行。 它保证容器（containers）都运行在 Pod 中。

## 镜像

`minikube start  --image-mirror-country='cn' --insecure-registry 172.21.14.206:5000 --v=8`



``` json

docker tag  registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v1.24.1  k8s.gcr.io/kube-apiserver:v1.24.1
docker tag  registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v1.24.1  k8s.gcr.io/kube-proxy:v1.24.1
docker tag  registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:v1.24.1  k8s.gcr.io/kube-controller-manager:v1.24.1
docker tag  registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v1.24.1  k8s.gcr.io/kube-scheduler:v1.24.1
docker tag  registry.cn-hangzhou.aliyuncs.com/google_containers/etcd:3.5.3-0  k8s.gcr.io/etcd:3.5.3-0
docker tag  registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.7 k8s.gcr.io/pause:3.7
docker tag  registry.cn-hangzhou.aliyuncs.com/google_containers/coredns:v1.8.6 k8s.gcr.io/coredns:v1.8.6
docker tag  registry.cn-hangzhou.aliyuncs.com/google_containers/storage-provisioner:v5 k8s.gcr.io/storage-provisioner:v5
docker tag  registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.6 k8s.gcr.io/pause:3.6

```


## 命令

`kubectl  delete  pod,service -l app.kubernetes.io/name=ingress-nginx` 删除 label 相关的pod 和service

`kubectl cordon $NODENAME` 节点设置为不可调度

`kubectl describe node <节点名称>` 查看node

`kubectl get deployments` 查看 deploy

`kubectl describe deployment nginx-deployment` 查看 deploy info

`kubectl get rs` 查看rs，ReplicaSet  = rs

`kubectl rollout status deployment/nginx-deployment` 查看滚动状态

`kubectl rollout history deployment/nginx-deployment` 滚动更新历史

`kubectl rollout undo deployment/nginx-deployment --to-revision=2` 回滚

`kubectl  api-resources  --namespaced` 查看资源,资源缩写，比如 Endpoint = ep, kubectl get ep EndpointName

参考 [kubectl command](https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands)


你需要在集群中的每个节点上都有一个可以正常工作的 容器运行时， 这样 kubelet 能启动 Pod 及其容器 **kubelet 启动 容器**

每个 Pod 都在每个地址族中获得一个唯一的 IP 地址。 Pod 中的每个容器共享网络名字空间，包括 IP 地址和网络端口。 **Pod 内 的容器可以使用 localhost 互相通信**。

Kubernetes 为 Pods 提供自己的 IP 地址，并为一组 Pod 提供相同的 DNS 名， 并且可以在它们之间进行负载均衡服务（Service）将运行在一组 Pods 上的应用程序公开为网络服务的抽象方法。 **Service 为 Pods 负载均衡**

Kubernetes 为该服务分配一个 IP 地址（有时称为 "集群IP"），该 IP 地址由服务代理使用。 **服务IP = 集群IP**

ClusterIP：通过集群的内部 IP 暴露服务，选择该值时服务只能够在集群内部访问。 这也是默认的 ServiceType **只能在集群内部访问对应EndPoint，如果外部访问 type = NodePort**

`kubectl EXPOSE` 服务选择算符的控制器不断扫描与其选择器匹配的 Pod，然后将所有更新发布到也称为 “my-service” 的 Endpoint 对象。 **label selector**

Kubernetes 采用的是中心辐射型（Hub-and-Spoke）API 模式。

## 控制面(API 服务器)到节点通信方式

1. kubelet
2. api 服务器代理功能


API 服务器到节点、Pod 和服务

1. HTTP 方式


向api 服务器添加 node

1. kubelet 自注册
2. 手动添加

没有两个 Node 可以同时使用相同的名称

要标记一个 Node 为不可调度

`kubectl cordon $NODENAME`

## 节点状态

`kubectl describe node <节点名称>`

- HostName : 内核报告
- ExternalIP: 通常是节点的可外部路由（从集群外可访问）的 IP 地址
- InternalIP: 通常是节点的仅可在集群内部路由的 IP 地址


## 心跳

1. .status
2. lease(租约)对象

kubelet 会更新 .status。 .status 更新的默认间隔为 5 分钟

kubelet 会创建并每 10 秒（默认更新间隔时间）更新 Lease 对象

与 Node 的 .status 更新相比，Lease 是一种轻量级资源。 使用 Lease 来表达心跳在大型集群中可以减少这些更新对性能的影响

## Deployment

一个 Deployment 为 Pod 和 ReplicaSet 提供声明式的更新能力

.spec.template 是一个 Pod 模板。 它和 Pod 的语法规则完全相同。 只是这里它是嵌套的，因此不需要 apiVersion 或 kind

.spec.selector 必须匹配 .spec.template.metadata.labels，否则请求会被 API 拒绝

检查 Deployment 是否已创建

`kubectl get deployments`

`kubectl describe deployment nginx-deployment`

要查看 Deployment 上线状态

`kubectl rollout status deployment/nginx-deployment`

查看 Deployment 通过创建新的 ReplicaSet 并将其扩容到 3 个副本

`kubectl get rs`

通常不鼓励更新标签选择算符。建议你提前规划选择算符。

## 回滚

检查 Deployment 修订历史

`kubectl rollout history deployment/nginx-deployment`

撤消当前上线并回滚到以前的修订版本

`kubectl rollout undo deployment/nginx-deployment --to-revision=2`

## 缩放

`kubectl scale deployment/nginx-deployment --replicas=10`

仅当 Deployment Pod 模板（即 .spec.template）发生改变时，例如模板的标签或容器镜像被更新， 才会触发 Deployment 上线。其他更新（如对 Deployment 执行扩缩容的操作）不会触发上线动作。


