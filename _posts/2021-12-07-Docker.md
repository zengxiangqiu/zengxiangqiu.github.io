---
title: "Docker"
date:  2021-12-07 14:14:25 +0800
categories: [容器]
tags: [docker]
---

## 1. 镜像
### 1.1. RabbitMQ

```docker
docker run -d --hostname dev-rabbitmq --name dev-rabbitmq -p 8080:15672 -p 5672:5672  -v ~/docker/rabbitmq:/var/lib/rabbitmq   rabbitmq:3-management
```

测试环境下，映射端口 -p 5672:5672

`http://localhost:8080` 访问web UI 管理

### 1.2. redis

运行 redis 作为 replica

```docker
docker run \
-p 6380:6379/tcp \
--name redis-slave \
-v /myredis:/usr/local/etc/redis \
--privileged=true \
-d redis redis-server /etc/redis/redis.conf \
--appendonly yes
```
参考[文章](https://developpaper.com/install-and-deploy-redis-using-docker-configuration-file-startup/)

关于 `-p` [stackoverflow](https://stackoverflow.com/questions/55171688/cant-connect-to-docker-redis-container-from-the-host-using-stackexchange-redis)

为什么在master redis-cli info 看到的slave ip 和 port 不是想要的,参考[官方文档](https://redis.io/topics/replication)

```plaintext
replica-announce-ip 5.5.5.5
replica-announce-port 1234
```


### 1.3. mysql

How to fix "mbind: Operation not permitted" in mysql error log

让mysql 静默处理异常（线程优先级）

```docker
service:
  mysql:
    image: mysql:8.0.15
    # ...
    cap_add:
      - SYS_NICE  # CAP_SYS_NICE
```

[docker部署mysql 实现远程连接](https://blog.csdn.net/weixin_42459563/article/details/80924634)

4.networks

Docker自身的4种网络工作方式
- host：容器将不会虚拟出自己的网卡，配置自己的IP等，而是使用宿主机的IP和端口。
- None：该模式关闭了容器的网络功能。
- Container：创建的容器不会创建自己的网卡，配置自己的IP，而是和一个指定的容器共享IP、端口范围。
- Bridge：此模式会为每一个容器分配、设置IP等，并将容器连接到一个docker0虚拟网桥，通过docker0网桥以及Iptables nat表配置与宿主机通信。


查看网络 `docker network ls`

参考 [Compose 中的网络](https://docs.docker.com/compose/networking/)

## 2. DOCKERFILE

1. DOCKERFILE EXPOSE

> it is just a type of documentation that tells a person who runs the container about the port that needs to be exposed or published to allow communication to the container from outside.

**作用是告诉运维哪些端口需要被映射**

摘自非常nice的网站 [educba](https://www.educba.com/docker-expose/)

2. DOCKERFILE COPY

  只支持linux系统，--chown 可以修改权限

3. DOCKERFILE BUILD

  `docker build -t <name of the docker image>:<tag> <path of the Dockerfile>`

4. DOCKERFILE FORMAT

  ```plaintext
  docker ps --format ‘json/table {{ .ID}}\t{{ .Names}}\t{{ .Networks}}\t{{ .Ports}}’ | jq
  ```

5. DOCKERFILE WAIT

  退出返回0，检查container状态

6. DOCKERFILE IMAGE HISTORY

  镜像命令记录

7. DOCKERFILE RUN

--restart

- no，默认策略，在容器退出时不重启容器
- on-failure，在容器非正常退出时（退出状态非0），才会重启容器
- on-failure:3，在容器非正常退出时重启容器，最多重启3次
- always，在容器退出时总是重启容器
- unless-stopped，在容器退出时总是重启容器，但是不考虑在Docker守护进程启动时就已经停止了的容器

8. DOKCERFILE REGISTRY

docker pull ubuntu  = docker pull docker.io/library/ubuntu

docker pull myregistrydomain:port/foo/bar 指示docker拉取位于myregistrydomain:port的镜像foo/bar

在myregistrydomain:port 主机中 registry是一个存储系统,默认的存储驱动程序是本地posix文件系统

运行你自己的Registry是与CI/CD系统集成并对其进行补充的绝佳解决方案。在典型的工作流程中，对源版本控制系统的提交将触发在CI系统上的构建，如果构建成功，则将新镜像推送到你的Registry。然后，来自Registry的通知将触发在暂存环境上的部署，或者通知其它系统有一个新镜像可用。


9. DOCKERFILE systemd

systemd 用于管理许多 Linux 发行版中的 Docker 守护进程

`sudo systemctl status docker`

10. Docker ENTRYPOINT

ENTRYPOINT [“executable”, “param1”, “param2”, ..]

ENTRYPOINT ["nginx", "-g", "daemon off;"]

ENTRYPOINT command param1 param2

ENTRYPOINT exec nginx -g “daemon off;”

11. DOCKER ATTACH

附加到正在运行的进程

docker attach --sig-proxy=false mynginx


## 3. 命令

```docker
docker inspect containerId 检查
docker ps -a 列出所有容器
docker images ls
docker container rm/start/stop containerId
docker exec -it container_name /bin/bash
docker system df docker 硬盘使用info
```


## Docker Compose

```docker
build:
  context: ./frontend
  dockerfile: Dockerfile.prod
```

`context`表示docker文件的上一级相对compose文件的相对路径

重建任一service

```docker
docker-compose up -d --no-deps --build <service_name>
```
--no-deps - Don't start linked services.

--build - Build images before starting containers.

## 4. 常见问题

1. Aspnetcore项目端口问题

```
    environment:
        - ASPNETCORE_URLS=https://+;
        - ASPNETCORE_HTTPS_PORT=5001
        - ASPNETCORE_Kestrel__Certificates__Default__Password=qazwsx
        - ASPNETCORE_Kestrel__Certificates__Default__Path=/https/aspnetapp.pfx
```

ASPNETCORE_URLS 优先 端口80和443，5001将不起作用，应`ASPNETCORE_URLS=https://+:5001`，再做端口映射


## 5. 参考

[exit, and your container is offline](https://dev.to/netk/getting-started-with-docker-running-an-ubuntu-image-4lk9)

[tty,docker -it ](https://qastack.cn/programming/30137135/confused-about-docker-t-option-to-allocate-a-pseudo-tty)

[daemon bash](https://linuxhandbook.com/exit-docker-container/)

[How to Deploy and Run Redis in Docker](https://phoenixnap.com/kb/docker-redis)

[delete all stopped containers](https://www.cloudytuts.com/tutorials/docker/how-to-remove-docker-containers-and-volumes/#:~:text=How%20to%20Remove%20Docker%20Containers%20and%20Volumes%201,of%20deleting%20Docker%20resources%20from%20the%20command-line.%20)

[如何获取 Docker 容器的 IP 地址](https://chinese.freecodecamp.org/news/how-to-get-a-docker-container-ip-address-explained-with-examples)

[Docker Exec Command With Examples](https://devconnected.com/docker-exec-command-with-examples)

[官网](https://docs.docker.com/engine/reference/commandline/ps/)

[docker compose up 部署多个rabbitmq实例持久化](https://dsinecos.github.io/blog/Multi-container-application-using-docker-compose#:~:text=.%2Fdata%2Flogs%3A%2Fvar%2Flog%2Frabbitmq-%20Maps%20the%20folder%20to%20store%20RabbitMQ%20logs,and%20can%20keep%20track%20of%20our%20data%20)

