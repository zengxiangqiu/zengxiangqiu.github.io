---
title: "gitlab"
date:  2022-06-15 11:13:36 +0800
categories: [工具]
tags: [工具]
---

`docker install gitlab-ce`

```dockerfile
sudo docker run --detach \
  --hostname gitlab.example.com \
  --publish 443:443 --publish 80:80 --publish 22:22 \
  --name gitlab \
  --restart always \
  --volume $GITLAB_HOME/config:/etc/gitlab \
  --volume $GITLAB_HOME/logs:/var/log/gitlab \
  --volume $GITLAB_HOME/data:/var/opt/gitlab \
  --shm-size 256m \
  gitlab/gitlab-ce:latest
```

登陆 http://gitlab.example.com/user/sign_in, account:root,password 查看 /srv/gitlab/config/initial_root_password,24小时后失效，在界面上重置密码

如忘记root password,可进入容器，exec /bin/bash ,再启用控制台gitlab-rails console -e production, 找到user = User.where(id:1).first,修改密码user.password = "xxxxxx" 再次确认 user.password_confirm = "xxxxxx" ，保存 user.save!, 退出控制台 quit



##  CI

需 install git runner ，参考[runner install](https://docs.gitlab.com/runner/install/linux-repository.html)

```sh
sudo yum install gitlab-runner
```

注册runner,参考[register](https://docs.gitlab.com/runner/register/index.html#linux)

```sh
sudo gitlab-runner register
```

注意，token  在 gitlab repository CI 可以找到，runner executor 选择 docker ， default image 根据项目中用到但没有在yml 文件中定义的镜像

也可以指令注册

```sh
sudo gitlab-runner register -n --url https://your_gitlab.com --registration-token project_token --executor docker --description "Deployment Runner" --docker-image "docker:stable" --tag-list deployment --docker-privileged
```

yml 文件

```yml
image: node:18-alpine

cache:
  paths:
    - node_modules/

test_async:
  script:
    - npm config set proxy null
    - npm config set https-proxy null
    - npm config set registry http://registry.npmjs.org/
    - npm install
    - node --experimental-vm-modules  node_modules/jest/bin/jest.js --detectOpenHandles
```

`npm ERR! Error: connect ECONNREFUSED`

移除代理，让npm 从 offcial url download



## 迁移

[Migrate to a new server](https://docs.gitlab.com/ee/administration/backup_restore/#migrate-to-a-new-server)


[GitLab Docker images](https://docs.gitlab.com/ee/install/docker.html)

[重置用户密码](https://docs.gitlab.com/ee/security/reset_user_password.html#reset-the-root-password)

[How To Set Up a Continuous Deployment Pipeline with GitLab CI/CD on Ubuntu 18.04](https://www.digitalocean.com/community/tutorials/how-to-set-up-a-continuous-deployment-pipeline-with-gitlab-ci-cd-on-ubuntu-18-04)


